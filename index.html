<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ - Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
            --primary: #2c3e50;       
            --primary-light: #ecf0f1; 
            --accent: #27ae60;        
            --bg-color: #f4f7f6;      
            --white: #ffffff;
            --text-dark: #2c3e50;     
            --border: #dfe6e9;        
            --error: #e74c3c;         
            --warning: #f39c12;       
            --info: #3498db;          
            --behavior-pos: #00b894;
            --behavior-neg: #d63031;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            overflow: hidden;
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        #landingPage {
            padding: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            background: linear-gradient(to bottom, #fff, #f9fbfd);
        }

        .landing-header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .start-section {
            background: var(--primary-light);
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .designer-info {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #95a5a6;
            font-size: 0.9rem;
            width: 100%;
        }
        .designer-name { color: var(--accent); font-weight: bold; }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ --- */
        .workspace-toolbar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .toolbar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .toolbar-section-left { display: flex; gap: 10px; flex-wrap: wrap; }
        .toolbar-section-right { display: flex; gap: 10px; flex-wrap: wrap; margin-right: auto; }

        select {
            padding: 8px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            background: white;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn:hover { opacity: 0.9; }

        .btn-primary { background-color: var(--primary); }
        .btn-accent { background-color: var(--accent); }
        .btn-danger { background-color: var(--error); }
        .btn-warning { background-color: var(--warning); color: #2d3436; }
        .btn-info { background-color: var(--info); }
        .btn-purple { background-color: #9b59b6; }
        .btn-dark { background-color: #34495e; }
        .btn-vertical-mode { background-color: #95a5a6; color: white; }
        .btn-vertical-mode.active { background-color: #27ae60; box-shadow: 0 0 5px #27ae60; }
        .btn-alpha-sort { background-color: #34495e; color: white; }
        .btn-alpha-sort.active { background-color: #00b894; box-shadow: 0 0 5px #00b894; }

        /* Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù†Ù…Ø§Ø· */
        .mode-switcher {
            display: flex;
            background: #dfe6e9;
            border-radius: 8px;
            padding: 3px;
        }
        .mode-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: bold;
            color: #636e72;
            background: transparent;
            transition: 0.3s;
        }
        .mode-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .workspace { display: none; flex-direction: column; }
        .workspace.active { display: flex; }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .section-tabs-container { display: flex; gap: 5px; padding: 10px 20px 0; background: #fff; border-bottom: 2px solid #eee; overflow-x: auto; align-items: center; }
        .tab-btn { 
            padding: 8px 20px; background: #f1f2f6; border: 1px solid #ddd; border-bottom: none; border-radius: 8px 8px 0 0; 
            cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: bold; color: #7f8c8d; white-space: nowrap; position: relative; top: 2px;
            transition: all 0.2s;
        }
        .tab-btn:hover { background: #e3e6ea; }
        .tab-btn.active { 
            background: #fff; color: var(--primary); border-color: #eee; border-bottom: 2px solid #fff; z-index: 2; 
            box-shadow: 0 -3px 5px rgba(0,0,0,0.02); border-top: 3px solid var(--accent);
        }
        .smart-btn { border-top: 3px solid #3498db; background: #eaf6ff; color: #2980b9; }
        .smart-btn.active { background: #3498db; color: white; border-top-color: #2980b9; }
        .toggle-all-btn { background: none; border: none; color: var(--info); font-weight: bold; cursor: pointer; font-size: 0.85rem; margin-left: 10px; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ */
        .table-wrapper { overflow-x: auto; padding-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        thead { background-color: #ecf0f1; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th { padding: 12px 8px; color: #2c3e50; font-weight: 700; border-bottom: 2px solid #bdc3c7; white-space: nowrap; font-size: 0.9rem; text-align: center; }
        td { padding: 0; border-bottom: 1px solid #eee; text-align: center; height: 40px; }
        tr:hover { background-color: #f9f9f9; }
        tr.section-group-header td { background-color: #f8f9fa; color: var(--primary); font-weight: bold; text-align: right; padding: 8px 15px; border-top: 2px solid #dfe6e9; }
        
        .grade-input { width: 100%; height: 100%; border: none; text-align: center; font-family: 'Cairo', sans-serif; font-size: 1rem; background: transparent; outline: none; color: #2c3e50; transition: background 0.2s; }
        .grade-input:focus { background-color: #e3f2fd; box-shadow: inset 0 0 0 2px var(--info); }
        .grade-input:hover { background-color: #fafafa; }
        
        /* Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */
        .name-input-table { width: 100%; border: none; background: transparent; font-family: 'Cairo', sans-serif; font-size: 0.85rem; font-weight: 600; color: #34495e; text-align: right; outline: none; }
        .name-input-table:focus { border-bottom: 1px solid var(--primary); }

        td.name-cell { text-align: right; padding-right: 8px; min-width: 180px; max-width: 220px; }
        td.total-cell { font-weight: 800; color: var(--primary); background-color: #fdfdfd; font-size: 1.1rem; }
        td.level-cell { font-weight: bold; color: #fff; font-size: 0.9rem; text-shadow: 0 0 2px rgba(0,0,0,0.2); }
        td.section-cell { font-size: 0.85rem; color: #7f8c8d; }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª */
        .level-A { background-color: #2ecc71; } /* Ù…Ù…ØªØ§Ø² */
        .level-B { background-color: #1abc9c; } /* Ø¬ÙŠØ¯ Ø¬Ø¯Ø§ */
        .level-C { background-color: #3498db; } /* Ø¬ÙŠØ¯ */
        .level-D { background-color: #f39c12; } /* Ù…Ù‚Ø¨ÙˆÙ„ */
        .level-E { background-color: #e74c3c; } /* Ø¶Ø¹ÙŠÙ */

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„ÙˆÙƒ */
        .behavior-score { font-weight: bold; font-size: 1.1rem; }
        .behavior-score.full-mark { color: #f1c40f !important; text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
        .btn-behavior { padding: 4px 10px; font-size: 0.8rem; margin: 0 2px; border-radius: 4px; border:none; cursor:pointer;}
        .btn-pos { background-color: #e6fffa; color: #00b894; border: 1px solid #00b894; }
        .btn-neg { background-color: #fff5f5; color: #d63031; border: 1px solid #d63031; }
        .btn-view-log { background-color: #e3f2fd; color: #3498db; border: 1px solid #3498db; }
        .behavior-history { font-size: 0.75rem; color: #888; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; padding:0 5px;}

        /* Ø§Ù„ØªØ­Ù„ÙŠÙ„ */
        .analysis-section { padding: 30px; border-top: 1px solid #eee; display: none; background: #fff; }
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; text-align: center; border-bottom-width: 3px; }
        .stat-num { font-size: 1.8rem; font-weight: bold; margin-top: 5px; }
        .rates-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .rate-card { padding: 15px; border-radius: 8px; text-align: center; border: 1px solid; }
        .rate-card.red { background-color: #fff5f5; border-color: #ff7675; color: #e17055; }
        .rate-card.green { background-color: #f0fdf4; border-color: #00b894; color: #00b894; }
        .rate-box h5 { margin: 0 0 10px; font-size: 1.1rem; }
        .rate-val { font-size: 2rem; font-weight: bold; font-family: monospace; }
        .lists-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #dfe6e9; }
        .list-card { border: 1px solid #eee; border-radius: 8px; padding: 15px; }
        .list-card h4 { margin-top: 0; border-bottom: 2px solid; padding-bottom: 10px; font-size: 1.1rem; margin-bottom: 10px; }
        .top-list h4 { border-color: #2ecc71; color: #27ae60; }
        .bottom-list h4 { border-color: #ff7675; color: #e74c3c; }
        .student-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f5f5f5; }
        .student-item:last-child { border-bottom: none; }
        .student-score { font-weight: bold; font-family: monospace; font-size: 1.1em; }
        .top-list .student-score { color: #27ae60; }
        .bottom-list .student-score { color: #e74c3c; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1500; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 95%; max-height: 85vh; overflow-y: auto; } 
        textarea { width: 100%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; resize: vertical; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù„ÙˆÙƒ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .behavior-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .b-btn { padding: 10px; border: 1px solid #eee; border-radius: 5px; cursor: pointer; text-align: center; transition: 0.2s; font-weight:bold; }
        .b-btn:hover { transform: scale(1.02); }
        .b-pos { background: #e6fffa; border-color: #b2f5ea; color: #234e52; }
        .b-neg { background: #fff5f5; border-color: #fed7d7; color: #822727; }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„ÙˆÙƒ */
        .log-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; background: #fafafa; margin-bottom: 4px; border-radius: 4px; align-items: center; }
        .btn-delete-log { background-color: #ffeaea; color: #d63031; border: 1px solid #fab1a0; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        .btn-delete-log:hover { background-color: #ff7675; color: white; }

        #notification-area { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .notif { padding: 10px 20px; border-radius: 5px; color: white; margin-bottom: 5px; opacity: 0; transition: 0.3s; transform: translateY(-20px); }
        .notif.show { opacity: 1; transform: translateY(0); }
        .notif.success { background: var(--accent); } .notif.error { background: var(--error); } .notif.info { background: var(--info); }

        /* Print */
        @media print {
            @page { size: landscape; margin: 1cm; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; zoom: 90%; }
            .container { box-shadow: none; border: none; margin: 0; width: 100%; max-width: 100%; }
            .workspace-toolbar, .section-tabs-container, .btn, .action-btn, #landingPage, .modal, .input-row-add, .mode-switcher { display: none !important; }
            .workspace { display: block !important; }
            .print-header { display: block !important; text-align: center; border-bottom: 2px solid #333; margin-bottom: 10px; padding-bottom: 5px; }
            table { border: 1px solid #000; width: 100%; font-size: 10pt; page-break-after: always; } 
            th, td { border: 1px solid #000; padding: 4px; color: black; text-align: center; height: auto; page-break-inside: avoid; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            .print-title-row { display: table-row !important; }
            .print-title-row th { background-color: #fff !important; border: none !important; border-bottom: 2px solid #000 !important; font-size: 1.4rem; padding: 15px; }
            tr.section-group-header { display: table-row; }
            tr.section-group-header td { background-color: #ddd !important; color: #000 !important; border: 1px solid #000; font-weight: bold; text-align: center; font-size: 1.2rem; }
            td.name-cell { font-size: 9pt; font-weight: normal; min-width: auto; width: 20%; text-align: right; padding-right: 5px; }
            .grade-input, .name-input-table { text-align: center; padding: 0; font-size: 10pt; border: none; }
            #analysisSection { display: none !important; }
            .analysis-print-container { display: block !important; }
            .grade-report-page { page-break-before: always; padding: 20px; border: 1px solid #ccc; margin-bottom: 20px; }
            .analysis-print-title { display: block; margin-bottom: 20px; text-decoration: underline; font-weight:bold; font-size:1.4rem; text-align:center;}
            .stats-grid { grid-template-columns: repeat(5, 1fr) !important; gap: 10px; }
            .rates-grid { display: grid !important; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
            .lists-wrapper { display: grid !important; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
            .simple-bar-chart { display: flex; height: 150px; align-items: flex-end; gap: 10px; margin-top: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
            .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
            .bar { width: 100%; background: #ddd; border-radius: 3px 3px 0 0; min-height: 1px; position: relative; }
            .bar-label { font-size: 0.8rem; margin-top: 5px; text-align: center; }
            .bar-val { font-size: 0.9rem; font-weight: bold; margin-bottom: 2px; }
            
            /* Ø¬Ø¯ÙˆÙ„ Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .behavior-log-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            .behavior-log-table th, .behavior-log-table td { border: 1px solid #ccc; padding: 8px; text-align: right; }
            .behavior-log-table th { background: #f0f0f0; font-weight: bold; }
            
            .print-footer { display: flex !important; justify-content: space-between; margin-top: 30px; padding-top: 10px; border-top: 1px solid #ccc; page-break-inside: avoid; }
            input[type="number"], input[type="text"] { border: none; background: none; width: auto; appearance: textfield; }
        }
        .print-header, .print-footer { display: none; }
    </style>
</head>
<body>

<div id="notification-area"></div>
<input type="file" id="restoreFileInput" style="display:none;" accept=".json" onchange="restoreBackup(this)">

<!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="landingPage">
    <div class="landing-header">
        <h1 style="color:var(--primary)">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h1>
        <p>Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</p>
    </div>

    <div class="start-section">
        <label style="display:block; margin-bottom:15px; font-weight:bold; color:var(--primary); font-size:1.2rem;">ğŸ‘‡ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
        <select id="landingGradeSelect" onchange="startApp(this.value)" style="width:100%; padding:15px; font-size:1.1rem; border:2px solid var(--accent); border-radius:8px;">
            <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
            <optgroup label="Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©"><option value="5-9">Ø§Ù„ØµÙÙˆÙ (5 - 9)</option></optgroup>
            <optgroup label="Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ"><option value="10-11">Ø§Ù„ØµÙÙˆÙ (10 - 11)</option><option value="12">Ø§Ù„ØµÙ (12)</option></optgroup>
        </select>
    </div>
    <div class="designer-info">ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: <span style="color:var(--accent); font-weight:bold;">Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø®Ù„Ù Ø§Ù„Ø±ÙˆØ§Ø­ÙŠ</span></div>
</div>

<!-- Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ -->
<div id="workspace" class="workspace">
    <div class="workspace-toolbar">
        <div class="toolbar-row">
            <div class="toolbar-section-left">
                <button class="btn btn-danger" onclick="returnToMain()">ğŸ  Ø®Ø±ÙˆØ¬</button>
                <span style="font-weight:bold; color:var(--primary); font-size:1.1rem; padding:0 10px; border-right:2px solid #ddd;" id="currentStageLabel"></span>
                <div class="mode-switcher">
                    <button class="mode-btn active" id="modeGradeBtn" onclick="switchMode('grades')">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
                    <button class="mode-btn" id="modeBehaviorBtn" onclick="switchMode('behavior')">âš–ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„ÙˆÙƒ</button>
                </div>
            </div>
            <div class="toolbar-section-right" style="display: flex; align-items: center; gap: 5px;">
                 <label style="font-size:0.9rem; color:#555;">ğŸ“¥ Ø¥Ø¯Ø±Ø§Ø¬ Ø´Ø¹Ø¨Ø©:</label>
                 <select id="bulkImportSelect" onchange="importSectionStudents(this.value)" style="min-width:150px; border-color: var(--accent);"></select>
            </div>
        </div>
        <div class="toolbar-row">
            <div class="toolbar-section-left">
                <button class="btn btn-purple" onclick="downloadBackup()">ğŸ“¥ Ø­ÙØ¸ Ù†Ø³Ø®Ø©</button>
                <button class="btn btn-primary" onclick="document.getElementById('restoreFileInput').click()">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                <button class="btn btn-warning" onclick="openClearModal()">ğŸ—‘ï¸ ØªØµÙÙŠØ©</button>
                <button id="verticalModeBtn" class="btn btn-vertical-mode" onclick="toggleVerticalMode()">â¬‡ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù…ÙˆØ¯ÙŠ: Ù…Ø¹Ø·Ù„</button>
                <button id="sortAlphaBtn" class="btn btn-alpha-sort" onclick="toggleSortAlpha()">ğŸ”  ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ: Ù…Ø¹Ø·Ù„</button>
            </div>
            <div class="toolbar-section-right">
                 <button class="btn btn-info" onclick="openNamesModal()">ğŸ‘¥ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
                <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button class="btn btn-accent" onclick="exportToExcel()">ğŸ“Š Excel</button>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div id="sectionTabs" class="section-tabs-container"></div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ -->
    <div class="table-wrapper">
        <table id="gradesTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
        
        <div id="gradesControls" class="input-row-add" style="padding:10px; background:#fff; border-bottom:1px solid #eee; display:flex; gap:10px; align-items:center; justify-content:center;">
            <input type="text" id="quickAddName" placeholder="Ø§Ø³Ù… Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯..." style="padding:8px; border:1px solid #ddd; border-radius:5px; width:250px;">
            <button class="btn btn-accent" onclick="quickAddStudent()">+ Ø¥Ø¶Ø§ÙØ©</button>
        </div>

        <div id="emptyMsg" style="text-align: center; padding: 30px; color: #bdc3c7; display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>
    </div>
    
    <div id="printContainer"></div>

    <div id="analysisSection" class="analysis-section">
        <h3 style="color:var(--primary); margin-bottom:20px;">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹)</h3>
        <div class="stats-grid">
            <div class="stat-card" style="border-bottom-color:#2c3e50"><h5>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h5><div id="statTotal" class="stat-num" style="color:#2c3e50">0</div></div>
            <div class="stat-card" style="border-bottom-color:#e74c3c"><h5>Ø¶Ø¹ÙŠÙ</h5><div id="statWeak" class="stat-num" style="color:#e74c3c">0</div></div>
            <div class="stat-card" style="border-bottom-color:#f39c12"><h5>Ù…Ù‚Ø¨ÙˆÙ„</h5><div id="statAcc" class="stat-num" style="color:#f39c12">0</div></div>
            <div class="stat-card" style="border-bottom-color:#3498db"><h5>Ø¬ÙŠØ¯</h5><div id="statGood" class="stat-num" style="color:#3498db">0</div></div>
            <div class="stat-card" style="border-bottom-color:#1abc9c"><h5>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</h5><div id="statVGood" class="stat-num" style="color:#1abc9c">0</div></div>
            <div class="stat-card" style="border-bottom-color:#2ecc71"><h5>Ù…Ù…ØªØ§Ø²</h5><div id="statExc" class="stat-num" style="color:#2ecc71">0</div></div>
        </div>
        <div class="rates-grid">
            <div class="rate-card red"><h5>âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯Ù†ÙŠ (< 5)</h5><div class="stat-num" id="rateLow">0%</div></div>
            <div class="rate-card green"><h5>ğŸŒŸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙÙˆÙ‚ (Ø£ØŒ Ø¨)</h5><div class="stat-num" id="rateHigh">0%</div></div>
        </div>
        <div class="chart-wrapper"><canvas id="analysisChart"></canvas></div>
        <div class="lists-wrapper">
            <div class="list-card top-list"><h4 style="color:#27ae60; border-color:#2ecc71">ğŸŒŸ Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h4><div id="topList"></div></div>
            <div class="list-card bottom-list"><h4 style="color:#c0392b; border-color:#e74c3c">âš ï¸ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Ø£Ù‚Ù„ 10)</h4><div id="bottomList"></div></div>
        </div>
    </div>

    <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¬Ù…Ø¹ -->
    <div id="printAnalysisContainer" class="analysis-print-container"></div>

    <div class="print-footer">
        <div style="flex:1; text-align:right;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…: ........................</div>
        <div style="flex:1; text-align:left;">ÙŠØ¹ØªÙ…Ø¯ØŒ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ........................</div>
    </div>
</div>

<!-- Modals -->
<div id="namesModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø¨ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡</h3>
        <div style="margin-bottom:10px;"><label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</label> <select id="modalStageSelect" onchange="loadSectionsForModal()" style="width:100%"><option value="5-9">5-9</option><option value="10-11">10-11</option><option value="12">12</option></select></div>
        <div style="margin-bottom:15px;"><label>Ø§Ù„Ø´Ø¹Ø¨Ø©:</label> <div id="modalSectionList" class="modal-section-list"></div> <input type="text" id="modalSectionName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©..." style="width:100%; padding:8px; border:1px solid #ddd; margin-top:5px;"></div>
        <label>Ø§Ù„Ø·Ù„Ø§Ø¨:</label><textarea id="modalNamesText"></textarea>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:15px;"><button class="btn btn-accent" onclick="saveSectionNames()">ğŸ’¾ Ø­ÙØ¸</button><button class="btn btn-danger" onclick="document.getElementById('namesModal').classList.remove('active')">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
</div>

<div id="behaviorModal" class="modal">
    <div class="modal-content" style="max-width:500px;">
        <h3 id="behaviorStudentName" style="color:var(--primary); margin-top:0;">ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙˆÙƒ</h3>
        <div style="margin-bottom: 15px; text-align: center;">
            <label style="font-weight:bold;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù„ÙˆÙƒ: </label>
            <input type="date" id="behaviorDate" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-family:'Cairo';">
        </div>
        <input type="hidden" id="behaviorStudentIndex">
        
        <h4 style="color:#27ae60; margin-bottom:5px;">ğŸ‘ ØªØ¹Ø²ÙŠØ² (Ø¥ÙŠØ¬Ø§Ø¨ÙŠ)</h4>
        <div class="behavior-btn-grid">
            <div class="b-btn b-pos" onclick="addBehaviorLog('Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù…ÙŠØ²Ø©', 0.5)">Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù…ÙŠØ²Ø© (+0.5)</div>
            <div class="b-btn b-pos" onclick="addBehaviorLog('Ø§Ù†ØªØ¨Ø§Ù‡ ÙˆØªØ±ÙƒÙŠØ²', 0.25)">Ø§Ù†ØªØ¨Ø§Ù‡ ÙˆØªØ±ÙƒÙŠØ² (+0.25)</div>
            <div class="b-btn b-pos" onclick="addBehaviorLog('ØªÙ‚ÙŠØ¯ Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª', 0.25)">ØªÙ‚ÙŠØ¯ Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª (+0.25)</div>
            <div class="b-btn b-pos" onclick="addBehaviorLog('Ø§Ù†ØªØ¸Ø§Ù…', 0.5)">Ø§Ù†ØªØ¸Ø§Ù… (+0.5)</div>
            <div class="b-btn b-pos" onclick="addBehaviorLog('Ø¥Ø­Ø¶Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª', 0.25)">Ø¥Ø­Ø¶Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª (+0.25)</div>
            <div class="b-btn b-pos" onclick="addBehaviorLog('Ù…Ø´Ø§Ø±ÙƒØ© ÙØ¹Ø§Ù„Ø©', 0.5)">Ù…Ø´Ø§Ø±ÙƒØ© ÙØ¹Ø§Ù„Ø© (+0.5)</div>
        </div>

        <h4 style="color:#c0392b; margin-bottom:5px; margin-top:15px;">ğŸ‘ ØªÙ†Ø¨ÙŠÙ‡ (Ø³Ù„Ø¨ÙŠ)</h4>
        <div class="behavior-btn-grid">
            <div class="b-btn b-neg" onclick="addBehaviorLog('Ø¹Ø¯Ù… Ø¥Ø­Ø¶Ø§Ø± Ø£Ø¯ÙˆØ§Øª', -0.5)">Ø¹Ø¯Ù… Ø¥Ø­Ø¶Ø§Ø± Ø£Ø¯ÙˆØ§Øª (-0.5)</div>
            <div class="b-btn b-neg" onclick="addBehaviorLog('ØªØ£Ø®ÙŠØ± Ø¹Ù† Ø§Ù„Ø­ØµØ©', -0.5)">ØªØ£Ø®ÙŠØ± (-0.5)</div>
            <div class="b-btn b-neg" onclick="addBehaviorLog('Ø£Ø­Ø§Ø¯ÙŠØ« Ø¬Ø§Ù†Ø¨ÙŠØ©', -0.5)">Ø£Ø­Ø§Ø¯ÙŠØ« Ø¬Ø§Ù†Ø¨ÙŠØ© (-0.5)</div>
            <div class="b-btn b-neg" onclick="addBehaviorLog('Ø¹Ø¯Ù… Ø§Ø­ØªØ±Ø§Ù…', -1)">Ø¹Ø¯Ù… Ø§Ø­ØªØ±Ø§Ù… (-1)</div>
            <div class="b-btn b-neg" onclick="addBehaviorLog('Ø¥Ø®Ù„Ø§Ù„ Ø¨Ø§Ù„Ø­ØµØ©', -1)">Ø¥Ø®Ù„Ø§Ù„ Ø¨Ø§Ù„Ø­ØµØ© (-1)</div>
            <div class="b-btn b-neg" onclick="addBehaviorLog('Ù†ÙˆÙ…/Ø³Ø±Ø­Ø§Ù†', -0.5)">Ù†ÙˆÙ…/Ø³Ø±Ø­Ø§Ù† (-0.5)</div>
        </div>
        
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
        <h4 style="margin: 5px 0;">Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª:</h4>
        <div id="behaviorLogList" style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-bottom: 15px; font-size: 0.9rem;"></div>

        <div style="margin-top:20px; text-align:center; display:flex; justify-content:center; gap:10px;">
             <button class="btn btn-danger" onclick="clearBehaviorLog()">ğŸ—‘ï¸ ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
             <button class="btn btn-dark" onclick="document.getElementById('behaviorModal').classList.remove('active')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="clearModal" class="modal">
    <div class="modal-content" style="max-width:400px; text-align:center;">
        <h3 style="color:var(--error);">âš ï¸ ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <div style="display:flex; flex-direction:column; gap:10px; margin:20px 0;">
            <button class="btn btn-warning" onclick="executeClear(1)">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙÙ‚Ø·</button>
            <button class="btn btn-warning" onclick="executeClear(2)">ğŸ“‹ Ù…Ø³Ø­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø´Ø¹Ø¨</button>
            <button class="btn btn-danger" onclick="executeClear(3)">ğŸ”¥ Ù…Ø³Ø­ Ø´Ø§Ù…Ù„</button>
        </div>
        <button class="btn btn-dark" onclick="document.getElementById('clearModal').classList.remove('active')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script>
    const SCHEMAS = {
        '5-9': { name: 'Ø§Ù„ØµÙÙˆÙ (5-9)', total: 60, fields: [{ id: 'oral', label: 'Ø§Ù„Ø¹Ø±Ø¶<br>Ø§Ù„Ø´ÙÙˆÙŠ<br>(10)', max: 10 }, { id: 'q1', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(5)', max: 5 }, { id: 'q2', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(5)', max: 5 }, { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(15)', max: 15, isKey: true }, { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(15)', max: 15 }, { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(10)', max: 10 }] },
        '10-11': { name: 'Ø§Ù„ØµÙÙˆÙ (10-11)', total: 40, fields: [{ id: 'q1', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(5)', max: 5 }, { id: 'q2', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(5)', max: 5 }, { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(10)', max: 10, isKey: true }, { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(10)', max: 10 }, { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(10)', max: 10 }] },
        '12': { name: 'Ø§Ù„ØµÙ (12)', total: 30, fields: [{ id: 'shortQ', label: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©<br>Ø§Ù„Ù‚ØµÙŠØ±Ø©<br>(5)', max: 5 }, { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(10)', max: 10, isKey: true }, { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(10)', max: 10 }, { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(5)', max: 5 }] }
    };

    let currentKey = null;
    let chartObj = null;
    let selectedSections = []; 
    let isVerticalMode = false;
    let isAlphaSort = false;
    let currentMode = 'grades'; 
    let dbSections = {}; 
    let dbGrades = { '5-9': [], '10-11': [], '12': [] };
    let dbBehavior = { '5-9': [], '10-11': [], '12': [] }; 
    let chartInstance = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        initChart();
    });

    function loadData() {
        const sec = localStorage.getItem('ss_sections');
        const grd = localStorage.getItem('ss_grades');
        const beh = localStorage.getItem('ss_behavior');
        
        if(sec) try { dbSections = JSON.parse(sec); } catch(e) { dbSections = {}; }
        if(grd) try { dbGrades = JSON.parse(grd); } catch(e) { dbGrades = { '5-9': [], '10-11': [], '12': [] }; }
        if(beh) try { dbBehavior = JSON.parse(beh); } catch(e) { dbBehavior = { '5-9': [], '10-11': [], '12': [] }; }
    }

    function saveData() {
        localStorage.setItem('ss_sections', JSON.stringify(dbSections));
        localStorage.setItem('ss_grades', JSON.stringify(dbGrades));
        localStorage.setItem('ss_behavior', JSON.stringify(dbBehavior));
    }

    function parseGrade(sectionName) {
        if(!sectionName) return 999;
        const match = sectionName.match(/\d+/);
        if(match) return parseInt(match[0]);
        return 999;
    }

    function startApp(key) {
        currentKey = key;
        currentMode = 'grades';
        selectedSections = [];
        document.getElementById('landingPage').style.display = 'none';
        document.getElementById('workspace').classList.add('active');
        document.getElementById('currentStageLabel').innerText = SCHEMAS[key].name;
        updateSectionDropdown();
        renderSectionTabs();
        renderTable();
    }

    function returnToMain() {
        currentKey = null;
        document.getElementById('landingGradeSelect').value = "";
        document.getElementById('workspace').classList.remove('active');
        document.getElementById('landingPage').style.display = 'flex';
        if(chartInstance) {
             chartInstance.data.datasets[0].data = [0,0,0,0,0];
             chartInstance.update();
        }
    }

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('modeGradeBtn').className = `mode-btn ${mode === 'grades' ? 'active' : ''}`;
        document.getElementById('modeBehaviorBtn').className = `mode-btn ${mode === 'behavior' ? 'active' : ''}`;
        document.getElementById('analysisSection').style.display = mode === 'grades' ? 'block' : 'none';
        document.getElementById('gradesControls').style.display = mode === 'grades' ? 'flex' : 'none';
        document.getElementById('verticalModeBtn').style.display = mode === 'grades' ? 'inline-block' : 'none';
        renderTable();
    }

    function calculateLevel(percentage) {
        if (percentage >= 90) return 'Ø£';
        if (percentage >= 80) return 'Ø¨';
        if (percentage >= 65) return 'Ø¬';
        if (percentage >= 50) return 'Ø¯';
        return 'Ù‡Ù€';
    }

    function getLevelColorClass(level) {
        if (level === 'Ø£') return 'level-A';
        if (level === 'Ø¨') return 'level-B';
        if (level === 'Ø¬') return 'level-C';
        if (level === 'Ø¯') return 'level-D';
        return 'level-E';
    }

    function renderTable() {
        const table = document.getElementById('gradesTable');
        table.innerHTML = ''; 
        const schema = SCHEMAS[currentKey];
        const thead = document.createElement('thead');
        
        let printTitle = currentMode === 'grades' ? `Ø³Ø¬Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© - ${schema.name}` : `Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© - ${schema.name}`;
        if (selectedSections.length > 0) printTitle += ` (Ø´Ø¹Ø¨ Ù…Ø­Ø¯Ø¯Ø©)`;

        let hHtml = `<tr class="print-title-row"><th colspan="100%">${printTitle}</th></tr><tr><th style="width:40px">#</th><th style="text-align:right; min-width:200px">Ø§Ù„Ø§Ø³Ù…</th><th style="width:70px">Ø§Ù„Ø´Ø¹Ø¨Ø©</th>`;
        if (currentMode === 'grades') {
            schema.fields.forEach(f => hHtml += `<th style="width:70px">${f.label}</th>`);
            hHtml += `<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹<br>(${schema.total})</th><th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th><th style="width:60px">Ø­Ø°Ù</th></tr>`;
        } else {
            hHtml += `<th>Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ù„ÙˆÙƒ<br>(Ù…Ù† 10)</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</th><th>Ø¢Ø®Ø± Ù…Ù„Ø§Ø­Ø¸Ø© (Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ®)</th></tr>`;
        }
        thead.innerHTML = hHtml;
        table.appendChild(thead);

        let data = [...(dbGrades[currentKey] || [])]; 
        if(selectedSections.length > 0) data = data.filter(item => selectedSections.includes(item.section));
        data.sort((a, b) => {
            const gradeA = parseGrade(a.section);
            const gradeB = parseGrade(b.section);
            if (gradeA !== gradeB) return gradeA - gradeB;
            if (a.section !== b.section) return a.section.localeCompare(b.section, 'ar');
            return isAlphaSort ? a.name.localeCompare(b.name, 'ar') : 0;
        });
        
        let currentSectionGroup = null;
        let tbody = null;
        let counter = 1;
        let printGroups = {}; 

        data.forEach((item, index) => {
            let groupKey = parseGrade(item.section);
            if (!printGroups[groupKey]) printGroups[groupKey] = [];
            printGroups[groupKey].push(item);

            if (item.section !== currentSectionGroup) {
                currentSectionGroup = item.section;
                tbody = document.createElement('tbody');
                tbody.className = "section-group"; 
                const groupHeader = document.createElement('tr');
                groupHeader.className = "section-group-header";
                const colSpan = currentMode === 'grades' ? (5 + schema.fields.length) : 6;
                groupHeader.innerHTML = `<td colspan="${colSpan}">Ø§Ù„Ø´Ø¹Ø¨Ø©: ${currentSectionGroup}</td>`;
                tbody.appendChild(groupHeader);
                table.appendChild(tbody);
            }

            const originalIndex = (dbGrades[currentKey] || []).indexOf(item); 
            const tr = document.createElement('tr');
            
            let html = `<td>${counter++}</td>
                        <td class="name-cell">
                            <input type="text" class="name-input-table" value="${item.name}" onchange="updateName(${originalIndex}, this.value)">
                        </td>
                        <td class="section-cell">${item.section}</td>`;
            
            if (currentMode === 'grades') {
                schema.fields.forEach(f => {
                    let val = item.scores[f.id] || "";
                    html += `<td><input type="number" class="grade-input" id="grade-${originalIndex}-${f.id}" value="${val === null ? '' : val}" min="0" max="${f.max}" step="0.5" onkeydown="handleGradeNavigation(event, ${originalIndex}, '${f.id}')" onchange="updateGrade(${originalIndex}, '${f.id}', this.value)"></td>`;
                });
                
                const stats = getStudentStats(item, schema);
                let totalDisplay = stats.max > 0 ? stats.obtained : "-";
                let levelChar = stats.hasGrade ? calculateLevel(stats.percentage) : "-";
                let levelClass = stats.hasGrade ? getLevelColorClass(levelChar) : "";
                
                html += `<td class="total-cell" id="total-${originalIndex}">${totalDisplay}</td>
                         <td class="level-cell ${levelClass}" id="level-${originalIndex}">${levelChar}</td>
                         <td><button class="action-btn del-btn" onclick="deleteItem(${originalIndex})">âœ•</button></td>`;
            } else {
                let bData = getBehaviorData(item.name, item.section);
                let score = bData ? bData.score : 0; 
                let lastNote = "-";
                if (bData && bData.logs.length > 0) {
                     const lastLog = bData.logs[bData.logs.length-1];
                     const dateStr = lastLog.date ? `[${lastLog.date}] ` : "";
                     lastNote = `${dateStr}${lastLog.reason}`;
                }
                
                html += `<td><span class="behavior-score ${score >= 10 ? 'full-mark' : ''}" style="color:${score < 0 ? 'red' : 'green'}">${score}</span></td>
                         <td>
                            <button class="btn-behavior btn-pos" title="Ø¥Ø¶Ø§ÙØ© ØªØ¹Ø²ÙŠØ²" onclick="openBehaviorModal(${originalIndex}, 'pos')">ğŸ‘</button>
                            <button class="btn-behavior btn-neg" title="Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡" onclick="openBehaviorModal(${originalIndex}, 'neg')">ğŸ‘</button>
                            <button class="btn-behavior btn-view-log" title="Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø­Ø°Ù" onclick="openBehaviorModal(${originalIndex}, 'view')">ğŸ“‹</button>
                         </td>
                         <td class="behavior-history">${lastNote}</td>`;
            }
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        document.getElementById('emptyMsg').style.display = data.length ? 'none' : 'block';
        if (currentMode === 'grades') {
            updateAnalysis(data);
            buildPrintReport(printGroups);
            document.getElementById('analysisSection').style.display = 'block';
        } else {
            document.getElementById('analysisSection').style.display = 'none';
            buildBehaviorPrintReport(printGroups);
        }
    }
    
    function getStudentStats(student, schema) {
        let obtained = 0;
        let max = 0;
        let hasGrade = false;
        
        if(!student.scores) return { obtained:0, max:0, percentage:0, hasGrade:false };

        schema.fields.forEach(f => {
            const val = student.scores[f.id];
            if (val !== null && val !== "" && val !== undefined) {
                obtained += parseFloat(val);
                max += f.max;
                hasGrade = true;
            }
        });

        let percentage = 0;
        if (max > 0) {
            percentage = (obtained / max) * 100;
        }

        return { obtained: parseFloat(obtained.toFixed(1)), max, percentage, hasGrade };
    }

    function getBehaviorData(name, section) {
        if (!dbBehavior[currentKey]) dbBehavior[currentKey] = [];
        return dbBehavior[currentKey].find(b => b.name === name && b.section === section);
    }
    
    function openBehaviorModal(idx, type) {
        const student = dbGrades[currentKey][idx];
        document.getElementById('behaviorStudentName').innerText = student.name;
        document.getElementById('behaviorStudentIndex').value = idx;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('behaviorDate').value = today;
        renderBehaviorLogList(student.name, student.section);
        document.getElementById('behaviorModal').classList.add('active');
    }
    
    function renderBehaviorLogList(name, section) {
        const listContainer = document.getElementById('behaviorLogList');
        listContainer.innerHTML = '';
        let bData = getBehaviorData(name, section);
        if (bData && bData.logs.length > 0) {
            bData.logs.forEach((log, i) => {
                const div = document.createElement('div');
                div.className = 'log-item';
                div.style.cssText = 'display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee; font-size:0.85rem;';
                const pts = log.points > 0 ? `+${log.points}` : log.points;
                const color = log.points > 0 ? 'green' : 'red';
                div.innerHTML = `<span><span style="color:#888">[${log.date}]</span> ${log.reason} (<span style="color:${color}">${pts}</span>)</span><button class="btn-delete-log" onclick="deleteBehaviorItem('${name}', '${section}', ${i})">Ø­Ø°Ù</button>`;
                listContainer.appendChild(div);
            });
        } else {
            listContainer.innerHTML = '<div style="text-align:center; color:#aaa; padding:10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</div>';
        }
    }

    function addBehaviorLog(reason, points) {
        const idx = document.getElementById('behaviorStudentIndex').value;
        const dateVal = document.getElementById('behaviorDate').value; 
        const student = dbGrades[currentKey][idx];
        if (!dbBehavior[currentKey]) dbBehavior[currentKey] = [];
        let bRecord = dbBehavior[currentKey].find(b => b.name === student.name && b.section === student.section);
        if (!bRecord) { bRecord = { name: student.name, section: student.section, score: 0, logs: [] }; dbBehavior[currentKey].push(bRecord); }
        bRecord.score += points;
        if (bRecord.score >= 10 && (bRecord.score - points) < 10) { alert(`ğŸ‰ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø·Ø§Ù„Ø¨ ${student.name} ÙˆØµÙ„ Ø¥Ù„Ù‰ 10 Ù†Ù‚Ø§Ø· Ø³Ù„ÙˆÙƒ! ÙŠØ±Ø¬Ù‰ ØªÙƒØ±ÙŠÙ…Ù‡.`); }
        const logDate = dateVal || new Date().toLocaleDateString();
        bRecord.logs.push({ reason: reason, points: points, date: logDate });
        saveData();
        renderBehaviorLogList(student.name, student.section);
        renderTable();
    }
    
    function deleteBehaviorItem(name, section, logIndex) {
        if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¯Ø±Ø¬Ø©ØŸ")) return;
        let bRecord = dbBehavior[currentKey].find(b => b.name === name && b.section === section);
        if (bRecord) {
            bRecord.score -= bRecord.logs[logIndex].points;
            bRecord.score = parseFloat(bRecord.score.toFixed(2));
            bRecord.logs.splice(logIndex, 1);
            saveData();
            renderBehaviorLogList(name, section);
            renderTable();
        }
    }
    
    function clearBehaviorLog() {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø³Ù„ÙˆÙƒ Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
        const idx = document.getElementById('behaviorStudentIndex').value;
        const student = dbGrades[currentKey][idx];
        if (!dbBehavior[currentKey]) dbBehavior[currentKey] = [];
        let bRecord = dbBehavior[currentKey].find(b => b.name === student.name && b.section === student.section);
        if (bRecord) {
            bRecord.score = 0;
            bRecord.logs = [];
            saveData();
            document.getElementById('behaviorModal').classList.remove('active');
            renderTable();
            alert("ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„ÙˆÙƒ Ù„Ù„Ø·Ø§Ù„Ø¨.");
        }
    }

    function buildPrintReport(groups) {
        const container = document.getElementById('printAnalysisContainer');
        if (!container) return;
        container.innerHTML = '';
        Object.keys(groups).sort((a,b) => parseInt(a)-parseInt(b)).forEach(key => {
            const groupData = groups[key];
            if (groupData.length === 0) return;
            const pageDiv = document.createElement('div');
            pageDiv.className = "grade-report-page";
            let title = key == 999 ? `ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ - Ø´Ø¹Ø¨ Ø£Ø®Ø±Ù‰` : `ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ - Ø§Ù„ØµÙ ${key}`;
            const stats = calculateStats(groupData);
            pageDiv.innerHTML = `
                <div class="analysis-print-title">${title}</div>
                <h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (${groupData.length} Ø·Ø§Ù„Ø¨)</h3>
                <div class="stats-grid">
                    <div class="stat-card" style="border-bottom-color:#2c3e50"><h5>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h5><div class="stat-num" style="color:#2c3e50">${stats.totalStudents}</div></div>
                    <div class="stat-card" style="border-bottom-color:#e74c3c"><h5>Ø¶Ø¹ÙŠÙ</h5><div class="stat-num" style="color:#e74c3c">${stats.counts[0]}</div></div>
                    <div class="stat-card" style="border-bottom-color:#f39c12"><h5>Ù…Ù‚Ø¨ÙˆÙ„</h5><div class="stat-num" style="color:#f39c12">${stats.counts[1]}</div></div>
                    <div class="stat-card" style="border-bottom-color:#3498db"><h5>Ø¬ÙŠØ¯</h5><div class="stat-num" style="color:#3498db">${stats.counts[2]}</div></div>
                    <div class="stat-card" style="border-bottom-color:#1abc9c"><h5>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</h5><div class="stat-num" style="color:#1abc9c">${stats.counts[3]}</div></div>
                    <div class="stat-card" style="border-bottom-color:#2ecc71"><h5>Ù…Ù…ØªØ§Ø²</h5><div class="stat-num" style="color:#2ecc71">${stats.counts[4]}</div></div>
                </div>
                <div class="simple-bar-chart">
                    ${stats.counts.map((val, i) => { const h = (val / (Math.max(...stats.counts)||1)) * 100; const colors = ['#e74c3c','#f39c12','#3498db','#1abc9c','#2ecc71']; const labels = ['Ø¶Ø¹ÙŠÙ','Ù…Ù‚Ø¨ÙˆÙ„','Ø¬ÙŠØ¯','Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹','Ù…Ù…ØªØ§Ø²']; return `<div class="bar-col"><div class="bar-val">${val}</div><div class="bar" style="height:${h}%; background:${colors[i]}"></div><div class="bar-label">${labels[i]}</div></div>`; }).join('')}
                </div>
                <div class="rates-grid" style="margin-top:20px;">
                    <div class="rate-card red"><h5>âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯Ù†ÙŠ</h5><div class="rate-val">${stats.lowPct}%</div></div>
                    <div class="rate-card green"><h5>ğŸŒŸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙÙˆÙ‚</h5><div class="rate-val">${stats.highPct}%</div></div>
                </div>
                <div style="page-break-before: always;"></div>
                <div class="analysis-print-title">Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø·Ù„Ø¨Ø© - Ø§Ù„ØµÙ ${key}</div>
                <div class="lists-wrapper">
                    <div class="list-card top-list"><h4>ğŸŒŸ Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h4>${stats.top10.map(s => `<div class="student-item"><span>${s.name} (${s.section})</span><b>${getStudentStats(s, SCHEMAS[currentKey]).obtained}</b></div>`).join('')}</div>
                    <div class="list-card bottom-list"><h4>âš ï¸ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Ø£Ù‚Ù„ 10)</h4>${stats.bottom10.map(s => `<div class="student-item"><span>${s.name} (${s.section})</span><b>${getStudentStats(s, SCHEMAS[currentKey]).obtained}</b></div>`).join('')}</div>
                </div>
            `;
            container.appendChild(pageDiv);
        });
    }

    function buildBehaviorPrintReport(groups) {
        const container = document.getElementById('printAnalysisContainer');
        container.innerHTML = '';
        Object.keys(groups).sort((a,b) => parseInt(a)-parseInt(b)).forEach(key => {
            const groupData = groups[key];
            if (groupData.length === 0) return;
            const pageDiv = document.createElement('div');
            pageDiv.className = "grade-report-page";
            let title = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© - Ø§Ù„ØµÙ ${key}`;
            
            let behaviorTableRows = '';
            groupData.forEach(student => {
                let bData = getBehaviorData(student.name, student.section);
                if (bData && bData.logs.length > 0) {
                    let logStr = bData.logs.map(l => `[${l.date}] ${l.reason} (${l.points > 0 ? '+' : ''}${l.points})`).join('<br>');
                    behaviorTableRows += `<tr><td>${student.name}</td><td>${student.section}</td><td style="font-weight:bold; color:${bData.score<5?'red':'green'}">${bData.score}</td><td style="font-size:0.8rem; text-align:right;">${logStr}</td></tr>`;
                }
            });

            if (!behaviorTableRows) behaviorTableRows = '<tr><td colspan="4" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ù„ÙˆÙƒÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</td></tr>';

            pageDiv.innerHTML = `
                <div class="analysis-print-title">${title}</div>
                <table class="behavior-log-table">
                    <thead><tr><th style="width:20%">Ø§Ù„Ø§Ø³Ù…</th><th style="width:10%">Ø§Ù„Ø´Ø¹Ø¨Ø©</th><th style="width:10%">Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
                    <tbody>${behaviorTableRows}</tbody>
                </table>
            `;
            container.appendChild(pageDiv);
        });
    }

    function calculateStats(data) {
        let counts = [0,0,0,0,0]; let low = 0, high = 0;
        data.forEach(d => {
            const stats = getStudentStats(d, SCHEMAS[currentKey]);
            if (!stats.hasGrade) return; 

            const p = stats.percentage;
            
            if (p >= 90) counts[4]++;      // Ù…Ù…ØªØ§Ø²
            else if (p >= 80) counts[3]++; // Ø¬ÙŠØ¯ Ø¬Ø¯Ø§
            else if (p >= 65) counts[2]++; // Ø¬ÙŠØ¯
            else if (p >= 50) counts[1]++; // Ù…Ù‚Ø¨ÙˆÙ„
            else counts[0]++;              // Ø¶Ø¹ÙŠÙ

            if (p < 50) low++;
            if (p >= 80) high++;
        });

        const sorted = [...data].sort((a,b) => {
            const statsA = getStudentStats(a, SCHEMAS[currentKey]);
            const statsB = getStudentStats(b, SCHEMAS[currentKey]);
            return statsB.percentage - statsA.percentage; 
        });
        
        return { 
            totalStudents: data.length, 
            counts: counts, 
            lowPct: data.length ? Math.round((low/data.length)*100) : 0, 
            highPct: data.length ? Math.round((high/data.length)*100) : 0, 
            top10: sorted.slice(0, 10), 
            bottom10: [...sorted].reverse().slice(0, 10), 
            top5: sorted.slice(0, 5), 
            bottom5: [...sorted].reverse().slice(0, 5) 
        };
    }

    function updateGrade(index, fieldId, value) {
        const student = dbGrades[currentKey][index];
        const schema = SCHEMAS[currentKey];
        let numVal = value === "" ? null : parseFloat(value);
        if (numVal !== null && isNaN(numVal)) numVal = null; 

        const field = schema.fields.find(f => f.id === fieldId);
        if (numVal !== null && numVal > field.max) {
            alert(`Ø®Ø·Ø£: Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ Ù‡ÙŠ ${field.max}`); numVal = field.max; document.getElementById(`grade-${index}-${fieldId}`).value = numVal;
        } else if (numVal !== null && numVal < 0) {
            numVal = 0; document.getElementById(`grade-${index}-${fieldId}`).value = numVal;
        }

        student.scores[fieldId] = numVal;
        if(field.isKey) student.keyScore = numVal || 0; 

        const stats = getStudentStats(student, schema);
        let totalDisplay = stats.max > 0 ? stats.obtained : "-";
        
        const totalCell = document.getElementById(`total-${index}`);
        if(totalCell) totalCell.innerText = totalDisplay;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆÙ‰
        const levelChar = stats.hasGrade ? calculateLevel(stats.percentage) : "-";
        const levelClass = stats.hasGrade ? getLevelColorClass(levelChar) : "";
        const levelCell = document.getElementById(`level-${index}`);
        if(levelCell) {
            levelCell.innerText = levelChar;
            levelCell.className = `level-cell ${levelClass}`;
        }
        
        saveData();
        const visibleData = dbGrades[currentKey].filter(item => selectedSections.length === 0 || selectedSections.includes(item.section));
        updateAnalysis(visibleData);
    }
    
    function updateName(index, newName) {
        if(!newName.trim()) return;
        dbGrades[currentKey][index].name = newName.trim();
        saveData();
        if(isAlphaSort) renderTable();
    }
    
    function handleGradeNavigation(e, r, c) {
        if(e.key==='Enter') { e.preventDefault(); if(isVerticalMode){let n=document.getElementById(`grade-${r+1}-${c}`);if(n){n.focus();n.select();}} else {let l=Array.from(document.querySelectorAll('.grade-input'));let i=l.indexOf(e.target);if(i>-1&&i<l.length-1){l[i+1].focus();l[i+1].select();}} }
        else if(e.key==='ArrowDown') { e.preventDefault(); let n=document.getElementById(`grade-${r+1}-${c}`); if(n){n.focus();n.select();} }
        else if(e.key==='ArrowUp') { e.preventDefault(); let p=document.getElementById(`grade-${r-1}-${c}`); if(p){p.focus();p.select();} }
    }
    function toggleVerticalMode() { isVerticalMode = !isVerticalMode; const b=document.getElementById('verticalModeBtn'); b.innerText=isVerticalMode?"â¬‡ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù…ÙˆØ¯ÙŠ: Ù…ÙØ¹Ù„":"â¬‡ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù…ÙˆØ¯ÙŠ: Ù…Ø¹Ø·Ù„"; b.classList.toggle('active'); }
    function toggleSortAlpha() { isAlphaSort = !isAlphaSort; const b=document.getElementById('sortAlphaBtn'); b.innerText=isAlphaSort?"ğŸ”  ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ: Ù…ÙØ¹Ù„":"ğŸ”  ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ: Ù…Ø¹Ø·Ù„"; b.classList.toggle('active'); renderTable(); }
    
    function quickAddStudent() { const n=document.getElementById('quickAddName').value.trim(); if(!n) return; const sc={}; SCHEMAS[currentKey].fields.forEach(f=>sc[f.id]=null); const sec=selectedSections.length>0?selectedSections[0]:"Ø¹Ø§Ù…"; if(!dbGrades[currentKey])dbGrades[currentKey]=[]; dbGrades[currentKey].push({name:n, section:sec, scores:sc, total:0, keyScore:0}); saveData(); renderTable(); document.getElementById('quickAddName').value=""; }
    
    function importSectionStudents(sec) { if(!sec || !dbSections[currentKey][sec]) return; const lst=dbSections[currentKey][sec].split('\n').map(s=>s.trim()).filter(s=>s); const sc={}; SCHEMAS[currentKey].fields.forEach(f=>sc[f.id]=null); if(!dbGrades[currentKey])dbGrades[currentKey]=[]; let c=0; lst.forEach(n=>{ if(!dbGrades[currentKey].some(s=>s.name===n)){ dbGrades[currentKey].push({name:n, section:sec, scores:{...sc}, total:0, keyScore:0}); c++; } }); if(c>0){ if(!selectedSections.includes(sec))selectedSections.push(sec); saveData(); renderSectionTabs(); renderTable(); alert(`ØªÙ… ${c}`); } document.getElementById('bulkImportSelect').value=""; }
    
    function renderSectionTabs() {
        const c=document.getElementById('sectionTabs'); c.innerHTML='';
        const t=document.createElement('button'); t.className="toggle-all-btn"; t.innerText=selectedSections.length>0?"Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„":"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"; t.onclick=()=>{if(selectedSections.length>0)selectedSections=[]; else if(dbSections[currentKey])selectedSections=Object.keys(dbSections[currentKey]); renderSectionTabs(); renderTable();};
        if(dbSections[currentKey]) Object.keys(dbSections[currentKey]).forEach(s=>{ const b=document.createElement('button'); b.className=`tab-btn ${selectedSections.includes(s)?"active":""}`; b.innerText=s; b.onclick=()=>{if(selectedSections.includes(s))selectedSections=selectedSections.filter(x=>x!==s); else selectedSections.push(s); renderSectionTabs(); renderTable();}; c.appendChild(b); });
        c.appendChild(t);
    }
    function updateSectionDropdown() { const s=document.getElementById('bulkImportSelect'); s.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø© --</option>'; if(dbSections[currentKey]) Object.keys(dbSections[currentKey]).forEach(k=>s.innerHTML+=`<option value="${k}">${k}</option>`); }
    function deleteItem(idx) { if(confirm("Ø­Ø°ÙØŸ")) { dbGrades[currentKey].splice(idx,1); saveData(); renderTable(); } }
    
    function updateAnalysis(data) {
        if(!chartInstance) return;
        const st = calculateStats(data);
        const el = id => document.getElementById(id);
        if(el('statTotal')) el('statTotal').innerText = st.totalStudents;
        ['Weak','Acc','Good','VGood','Exc'].forEach((k,i)=>el('stat'+k).innerText=st.counts[i]);
        el('rateLow').innerText=st.lowPct+"%"; el('rateHigh').innerText=st.highPct+"%";
        chartInstance.data.datasets[0].data=st.counts; chartInstance.update();
        el('topList').innerHTML=st.top10.map(s=>`<div class="student-item"><span>${s.name} (${s.section})</span><b>${getStudentStats(s, SCHEMAS[currentKey]).obtained}</b></div>`).join('');
        el('bottomList').innerHTML=st.bottom10.map(s=>`<div class="student-item"><span>${s.name} (${s.section})</span><b>${getStudentStats(s, SCHEMAS[currentKey]).obtained}</b></div>`).join('');
    }
    
    function openNamesModal() { document.getElementById('namesModal').classList.add('active'); document.getElementById('modalStageSelect').value=currentKey||"5-9"; loadSectionsForModal(); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function loadSectionsForModal() { const s=document.getElementById('modalStageSelect').value, d=document.getElementById('modalSectionList'); d.innerHTML=''; if(dbSections[s])Object.keys(dbSections[s]).forEach(k=>{const b=document.createElement('div'); b.className='section-tag'; b.innerText=k; b.onclick=()=>{document.getElementById('modalSectionName').value=k; document.getElementById('modalNamesText').value=dbSections[s][k];}; d.appendChild(b);}); const n=document.createElement('div'); n.className='section-tag new'; n.innerText='+'; n.onclick=()=>{document.getElementById('modalSectionName').value="";document.getElementById('modalNamesText').value="";}; d.appendChild(n); }
    function saveSectionNames() { const s=document.getElementById('modalStageSelect').value, n=document.getElementById('modalSectionName').value.trim(), t=document.getElementById('modalNamesText').value; if(!n) return alert("Ø§Ù„Ø§Ø³Ù…ØŸ"); if(!dbSections[s]) dbSections[s]={}; dbSections[s][n]=t; saveData(); loadSectionsForModal(); if(s===currentKey) {updateSectionDropdown(); renderSectionTabs();} }
    function openClearModal() { document.getElementById('clearModal').classList.add('active'); }
    function executeClear(t) { document.getElementById('clearModal').classList.remove('active'); if(!confirm("Ø£ÙƒÙŠØ¯ØŸ"))return; if(t===1||t===3)dbGrades[currentKey]=[]; if(t===2||t===3)delete dbSections[currentKey]; saveData(); if(currentKey){updateSectionDropdown(); renderSectionTabs(); renderTable();} }
    function downloadBackup() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify({s:dbSections,g:dbGrades,b:dbBehavior})],{type:'application/json'})); a.download='Backup.json'; a.click(); }
    function restoreBackup(i) { const r=new FileReader(); r.onload=e=>{try{const d=JSON.parse(e.target.result); dbSections=d.s;dbGrades=d.g;if(d.b)dbBehavior=d.b; saveData();location.reload();}catch(x){alert("Ø®Ø·Ø£");}}; if(i.files[0])r.readAsText(i.files[0]); }
    function exportToExcel() { const a=document.createElement('a'); a.href='data:application/vnd.ms-excel,'+encodeURIComponent(document.getElementById('gradesTable').outerHTML.replace(/<input.*?value="(.*?)".*?>/g,"$1").replace(/<button.*?<\/button>/g,"")); a.download='Grades.xls'; a.click(); }
    function initChart() { const c=document.getElementById('analysisChart'); if(c) chartInstance=new Chart(c.getContext('2d'),{type:'bar',data:{labels:['Ø¶Ø¹ÙŠÙ','Ù…Ù‚Ø¨ÙˆÙ„','Ø¬ÙŠØ¯','Ø¬ÙŠØ¯ Ø¬Ø¯Ø§','Ù…Ù…ØªØ§Ø²'],datasets:[{data:[0,0,0,0,0],backgroundColor:['#e74c3c','#f39c12','#3498db','#1abc9c','#2ecc71']}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}}); }
</script>
</body>
</html>