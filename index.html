<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ - Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙØ§ØªØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
            --primary: #3498db;       /* Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… */
            --primary-light: #f0f3f5; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© */
            --accent: #00b894;        /* Ø£Ø®Ø¶Ø± Ù‡Ø§Ø¯Ø¦ Ù„Ù„ØªØ±ÙƒÙŠØ² */
            --bg-color: #ffffff;      /* Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø© Ø¨ÙŠØ¶Ø§Ø¡ */
            --white: #ffffff;
            --text-dark: #2d3436;     /* Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ Ù„Ù„Ù†ØµÙˆØµ (Ø¨Ø¯Ù„ Ø§Ù„Ø£Ø³ÙˆØ¯) */
            --border: #dfe6e9;        /* Ù„ÙˆÙ† Ø­Ø¯ÙˆØ¯ ÙØ§ØªØ­ */
            --error: #ff7675;         /* Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
            --warning: #fdcb6e;       /* Ø£ØµÙØ± Ù‡Ø§Ø¯Ø¦ */
            --info: #74b9ff;          /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f9fbfd; /* Ø®Ù„ÙÙŠØ© Ø¹Ø§Ù…Ø© ÙØ§ØªØ­Ø© Ø¬Ø¯Ø§Ù‹ */
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.03); /* Ø¸Ù„ Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ */
            overflow: hidden;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        header {
            background-color: var(--white); /* Ù‡ÙŠØ¯Ø± Ø£Ø¨ÙŠØ¶ */
            color: var(--text-dark);
            padding: 25px;
            text-align: center;
            border-bottom: 3px solid var(--accent); /* Ø®Ø· Ù…Ù„ÙˆÙ† Ø£Ø³ÙÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± */
        }

        header h1 { margin: 0; font-size: 1.8rem; line-height: 1.4; color: var(--primary); }
        header p { margin: 10px 0 0; opacity: 0.7; font-size: 1rem; color: #636e72; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        #notification-area {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
        }
        .notification {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            text-align: center;
            font-weight: bold;
        }
        .notification.show { opacity: 1; transform: translateY(0); }
        .notification.error { background-color: var(--error); }
        .notification.success { background-color: var(--accent); }
        .notification.info { background-color: var(--info); }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .controls-bar {
            padding: 20px;
            background: #f8f9fa; /* Ø®Ù„ÙÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© ÙØ§ØªØ­Ø© Ø¬Ø¯Ø§Ù‹ */
            display: flex;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        .grade-selector {
            flex: 1;
            min-width: 200px;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ */
        .backup-controls {
            display: flex;
            gap: 10px;
            margin-right: auto; /* Ø¯ÙØ¹ Ù„Ù„ÙŠØ³Ø§Ø± */
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .workspace {
            display: none;
            flex-direction: column;
        }
        .workspace.active { display: flex; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ */
        #welcomeScreen {
            padding: 50px;
            text-align: center;
            color: #b2bec3;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .welcome-icon { font-size: 4rem; margin-bottom: 20px; color: #dfe6e9; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ÙÙ‚ÙŠ */
        .input-section {
            padding: 20px 15px;
            background-color: #fff;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-end;
            gap: 10px;
            transition: background 0.3s;
            border-bottom: 1px solid var(--border);
        }
        
        .input-section.edit-mode {
            background-color: #fffbf0; /* Ù„ÙˆÙ† ÙƒØ±ÙŠÙ…ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */
            position: relative;
            padding-top: 30px;
        }
        .input-section.edit-mode::after {
            content: "ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ - ÙŠØ±Ø¬Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª";
            position: absolute;
            top: 5px; left: 0; right: 0;
            text-align: center;
            font-size: 0.8rem;
            color: #e17055;
            font-weight: bold;
        }

        .form-group { 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            text-align: center;
        }

        .form-group.name-group { flex-grow: 2; min-width: 220px; }
        .form-group.grade-group { flex-grow: 1; min-width: 80px; max-width: 110px; }
        .form-group.btn-group { flex-grow: 0; min-width: 120px; }

        label { 
            margin-bottom: 5px; 
            font-weight: 700; 
            font-size: 0.85rem; 
            color: #636e72; 
            line-height: 1.2;
            text-align: center;
            min-height: 45px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        input, select {
            padding: 8px;
            border: 1px solid #b2bec3;
            border-radius: 6px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s;
            height: 42px;
            background-color: #fff;
            color: var(--text-dark);
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            padding: 0 20px;
            height: 42px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            color: white;
            transition: transform 0.1s, background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-add { background-color: var(--accent); width: 100%; }
        .btn-add:hover { background-color: #00a884; }
        .btn-add.update-mode { background-color: var(--warning); color: #2d3436; }
        
        .btn-tool { 
            background-color: #e3e8eb; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ù„Ù„Ø£Ø¯ÙˆØ§Øª */
            color: #2d3436;
            font-size: 0.9rem; 
            padding: 8px 15px; 
            height: auto; 
            border: 1px solid #dcdde1;
        }
        .btn-tool:hover { background-color: #dcdde1; }

        .btn-back { background-color: #ff7675; color: white; border: none; }
        .btn-back:hover { background-color: #d63031; }
        
        .btn-backup { background-color: #a29bfe; color: white; border: none; }
        .btn-backup:hover { background-color: #6c5ce7; }
        
        .btn-restore { background-color: #74b9ff; color: white; border: none; }
        .btn-restore:hover { background-color: #0984e3; }

        /* Ø²Ø± Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .btn-clear { background-color: #e17055; color: white; border: none; }
        .btn-clear:hover { background-color: #d63031; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-container { overflow-x: auto; padding: 0; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        thead { 
            background-color: #f1f2f6; /* Ø±Ø£Ø³ Ø¬Ø¯ÙˆÙ„ ÙØ§ØªØ­ */
            color: #2d3436; 
        }
        
        th, td { 
            padding: 12px 8px; 
            text-align: center; 
            border-bottom: 1px solid #eee; 
            vertical-align: middle; 
        }
        
        th { white-space: nowrap; font-size: 0.95rem; font-weight: 700; }
        tbody tr:hover { background-color: #f8f9fa; }
        
        .total-cell { 
            font-weight: bold; 
            color: var(--primary); 
            font-size: 1.1rem; 
            background-color: #fdfdfd;
        }

        .action-btn { padding: 5px 8px; border-radius: 5px; border: none; cursor: pointer; margin: 0 2px; }
        .edit-btn { background: #ffeaa7; color: #d35400; }
        .del-btn { background: #ffcccc; color: #c0392b; }

        /* Ø§Ù„ØªØ­Ù„ÙŠÙ„ */
        .analysis-container { padding: 30px; background: #ffffff; border-top: 1px solid var(--border); display: none; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 10px; 
            margin-bottom: 30px; 
        }
        
        .stat-box { 
            background: #fdfdfd; 
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid #eee;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); 
            text-align: center; 
            border-bottom-width: 3px; 
        }
        
        .stat-num { font-size: 2rem; font-weight: bold; color: var(--text-dark); margin: 10px 0; }
        .chart-wrapper { height: 300px; position: relative; }

        /* Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ù†Ø³Ø¨ Ø§Ù„ØªØ¯Ù†ÙŠ ÙˆØ§Ù„ØªÙÙˆÙ‚) */
        .rates-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .rate-box {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid;
        }
        .rate-box.red { background-color: #fff5f5; border-color: #ff7675; color: #e17055; }
        .rate-box.green { background-color: #f0fdf4; border-color: #00b894; color: #00b894; }
        .rate-box h5 { margin: 0 0 10px; font-size: 1.1rem; }
        .rate-val { font-size: 2rem; font-weight: bold; font-family: monospace; }

        /* Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ù…ØªØ¹Ø«Ø±ÙŠÙ† */
        .lists-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #dfe6e9;
        }
        .list-card {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #eee;
        }
        .list-card h4 {
            margin-top: 0;
            border-bottom: 2px solid;
            padding-bottom: 10px;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        .top-list h4 { border-color: #2ecc71; color: #27ae60; }
        .bottom-list h4 { border-color: #ff7675; color: #e74c3c; }

        .student-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-bottom: 1px solid #f1f2f6;
            font-size: 0.95rem;
        }
        .student-item:last-child { border-bottom: none; }
        .student-score { font-weight: bold; font-family: monospace; font-size: 1.1em; }
        .top-list .student-score { color: #27ae60; }
        .bottom-list .student-score { color: #e74c3c; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 2000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-box { background: white; padding: 30px; border-radius: 10px; width: 600px; max-width: 95%; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 200px; margin: 15px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; background: #fafafa; }
        
        .modal-section-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .section-tag { background: #f1f2f6; padding: 6px 16px; border-radius: 20px; cursor: pointer; white-space: nowrap; border: 1px solid #dfe6e9; color: #636e72; }
        .section-tag.active { background: var(--primary); color: white; border-color: var(--primary); }
        .section-tag.new { border-style: dashed; background: white; }

        /* Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            /* ÙØ±Ø¶ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙÙ‚ÙŠ */
            @page {
                size: landscape;
                margin: 0.5cm;
            }
            
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background: white;
                zoom: 100%;
            }

            .controls-bar, .input-section, .btn, .action-btn, .backup-controls, #notification-area, #welcomeScreen, .modal { display: none !important; }
            
            .container { 
                box-shadow: none; 
                margin: 0; 
                width: 100% !important; 
                max-width: 100% !important; 
                border: none; 
                padding: 0;
            }
            
            .workspace { display: block !important; }
            
            header { 
                border-bottom: 2px solid #b2bec3; 
                padding: 5px 0; 
                margin-bottom: 10px; 
                background: transparent;
            }
            header h1 { font-size: 20px; color: #2d3436; margin: 0; }
            header p { color: #636e72; margin: 0; font-size: 12px; }

            .table-container {
                overflow: visible !important; 
                display: block;
                width: 100%;
            }

            table { 
                border: 1px solid #b2bec3; 
                width: 100% !important; 
                border-collapse: collapse; 
                margin-top: 10px; 
                font-size: 12pt; 
                table-layout: auto; 
            }
            
            th, td { 
                border: 1px solid #b2bec3; 
                padding: 6px; 
                color: #2d3436; 
                text-align: center; 
                vertical-align: middle;
            }
            
            th:nth-child(1) { width: 5%; } 
            th:nth-child(2) { width: 25%; text-align: right; } 
            th:nth-child(3) { width: 10%; } 

            thead { background-color: #dfe6e9 !important; color: #2d3436 !important; -webkit-print-color-adjust: exact; }
            th:last-child, td:last-child { display: none; }
            
            .analysis-container { 
                display: block !important; 
                page-break-inside: avoid; 
                margin-top: 20px; 
                border: 1px solid #b2bec3; 
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
            }
            
            .stat-box {
                padding: 5px;
                border: 1px solid #dcdde1;
                box-shadow: none;
            }
            .stat-num { font-size: 1.5rem; color: #2d3436; }
            
            .chart-wrapper {
                height: 250px;
            }

            .lists-wrapper { display: grid !important; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; page-break-inside: avoid; }
            .list-card { border: 1px solid #ccc; }

            body.print-analysis-only .table-container { display: none; }
            
            .print-footer { 
                display: flex !important; 
                margin-top: 40px; 
                justify-content: space-between; 
                align-items: flex-end;
                border-top: 1px solid #b2bec3; 
                padding-top: 10px;
                page-break-inside: avoid;
                font-size: 12px;
                font-weight: bold;
                color: #2d3436;
            }
            .designer-credit { display: none !important; } 
        }
        .print-footer { display: none; }
    </style>
</head>
<body>

<div id="notification-area"></div>

<input type="file" id="restoreFileInput" style="display:none;" accept=".json" onchange="restoreBackup(this)">

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ -->
<div id="classModal" class="modal">
    <div class="modal-box">
        <h2 style="margin-top:0; color:var(--primary)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø¨ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡</h2>
        <div class="form-group">
            <label>1. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
            <select id="modalStageSelect" onchange="loadSectionsForModal()">
                <option value="5-9">Ø§Ù„ØµÙÙˆÙ (5 - 9)</option>
                <option value="10-11">Ø§Ù„ØµÙÙˆÙ (10 - 11)</option>
                <option value="12">Ø§Ù„ØµÙ (12)</option>
            </select>
        </div>
        <div style="margin-top: 15px;">
            <label>2. Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø´Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©:</label>
            <div id="modalSectionList" class="modal-section-list"></div>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© (Ù…Ø«Ø§Ù„: Ø®Ø§Ù…Ø³ 1):</label>
                <input type="text" id="modalSectionName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ù‡Ù†Ø§">
            </div>
        </div>
        <p style="margin-top:10px;">3. Ø§Ù†Ø³Ø® ÙˆØ§Ù„ØµÙ‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©:</p>
        <textarea id="classListText"></textarea>
        <div style="text-align: left; margin-top:auto;">
            <button class="btn btn-tool" onclick="saveSectionData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø¨Ø©</button>
            <button class="btn btn-tool" style="background:#e74c3c; color:white; border:none;" onclick="document.getElementById('classModal').classList.remove('active')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div id="clearDataModal" class="modal">
    <div class="modal-box" style="max-width: 400px; text-align: center;">
        <h2 style="margin-top:0; color:#c0392b;">âš ï¸ Ø®ÙŠØ§Ø±Ø§Øª ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
        <p style="margin-bottom: 20px; color:#7f8c8d;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­Ø°Ø±ØŒ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.</p>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-tool" onclick="performClear(1)">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙÙ‚Ø·</button>
            <button class="btn btn-tool" onclick="performClear(2)">ğŸ“‹ Ù…Ø³Ø­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø´Ø¹Ø¨</button>
            <button class="btn btn-tool" style="background-color:#e74c3c; color:white;" onclick="performClear(3)">ğŸ”¥ Ù…Ø³Ø­ Ø´Ø§Ù…Ù„ (Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·)</button>
        </div>
        
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
            <button class="btn btn-tool" onclick="document.getElementById('clearDataModal').classList.remove('active')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<div class="container">
    <header>
        <h1>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</h1>
        <p>ØªØµÙ…ÙŠÙ…: Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø®Ù„Ù Ø§Ù„Ø±ÙˆØ§Ø­ÙŠ | ÙŠØ­ÙˆÙŠ Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</p>
    </header>

    <div class="controls-bar">
        <div class="grade-selector">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
            <select id="gradeSelect" onchange="changeSchema()">
                <option value="" disabled selected>-- Ø­Ø¯Ø¯ Ø§Ù„ØµÙ Ù„Ù„Ø¨Ø¯Ø¡ --</option>
                <optgroup label="Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©">
                    <option value="5-9">Ø§Ù„ØµÙÙˆÙ (5 - 9)</option>
                </optgroup>
                <optgroup label="Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ">
                    <option value="10-11">Ø§Ù„ØµÙÙˆÙ (10 - 11)</option>
                    <option value="12">Ø§Ù„ØµÙ (12)</option>
                </optgroup>
            </select>
        </div>
        
        <div class="grade-selector" id="sectionSelectorDiv" style="display:none;">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
            <select id="mainSectionSelect" onchange="filterStudentsBySection()">
                <option value="">-- ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø¨ --</option>
            </select>
        </div>
        
        <div style="flex: 2; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
            <div class="backup-controls">
                <button class="btn btn-tool btn-backup" onclick="downloadBackup()">ğŸ“¥ Ø­ÙØ¸ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button class="btn btn-tool btn-restore" onclick="document.getElementById('restoreFileInput').click()">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button class="btn btn-tool btn-clear" onclick="confirmClearData()">ğŸ—‘ï¸ ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
            <button class="btn btn-tool" onclick="openNamesModal()">ğŸ‘¥ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø´Ø¹Ø¨</button>
            <button id="backBtn" type="button" class="btn btn-tool btn-back" style="display:none;" onclick="resetToMainMenu()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>

    <div id="welcomeScreen">
        <div class="welcome-icon">ğŸ“</div>
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ØµØ¯</h2>
        <p>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².</p>
        <p style="font-size:0.9rem; margin-top:10px; color:#b2bec3;">Ù†ØµÙŠØ­Ø©: Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ "Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª" Ø¯ÙˆØ±ÙŠØ§Ù‹ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</p>
    </div>

    <div id="workspace" class="workspace">
        <div style="padding: 0 20px; display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
             <button class="btn btn-tool" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„</button>
             <button class="btn btn-tool" onclick="exportToExcel()">ğŸ“Š Excel</button>
        </div>

        <div id="inputContainer" class="input-section"></div>

        <div class="table-container">
            <table id="gradesTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div id="emptyMsg" style="text-align: center; padding: 30px; color: #bdc3c7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
        </div>

        <div id="analysisSection" class="analysis-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary); margin:0;">ğŸ“ˆ ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚ØµÙŠØ± Ø§Ù„Ø£ÙˆÙ„</h3>
                <button class="btn btn-tool" style="background:#8e44ad; color:white; border:none;" onclick="printAnalysisOnly()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
            </div>
            <div class="stats-grid">
                <div class="stat-box" style="border-color: #e74c3c;"><h4>Ø¶Ø¹ÙŠÙ</h4><div class="stat-num" id="cntWeak" style="color: #e74c3c">0</div><small id="rangeWeak"></small></div>
                <div class="stat-box" style="border-color: #f39c12;"><h4>Ù…Ù‚Ø¨ÙˆÙ„</h4><div class="stat-num" id="cntAcc" style="color: #f39c12">0</div><small id="rangeAcc"></small></div>
                <div class="stat-box" style="border-color: #3498db;"><h4>Ø¬ÙŠØ¯</h4><div class="stat-num" id="cntGood" style="color: #3498db">0</div><small id="rangeGood"></small></div>
                <div class="stat-box" style="border-color: #1abc9c;"><h4>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</h4><div class="stat-num" id="cntVGood" style="color: #1abc9c">0</div><small id="rangeVGood"></small></div>
                <div class="stat-box" style="border-color: #2ecc71;"><h4>Ù…Ù…ØªØ§Ø²</h4><div class="stat-num" id="cntExc" style="color: #2ecc71">0</div><small id="rangeExc"></small></div>
            </div>

            <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
            <div class="rates-grid">
                <div class="rate-box red">
                    <h5>âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯Ù†ÙŠ (Ø£Ù‚Ù„ Ù…Ù† 5)</h5>
                    <div class="rate-val" id="lowRateVal">0%</div>
                </div>
                <div class="rate-box green">
                    <h5>ğŸŒŸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙÙˆÙ‚ (Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ ÙˆÙ…Ù…ØªØ§Ø²)</h5>
                    <div class="rate-val" id="highRateVal">0%</div>
                </div>
            </div>

            <div class="chart-wrapper"><canvas id="analysisChart"></canvas></div>

            <div class="lists-wrapper">
                <div class="list-card top-list">
                    <h4>ğŸŒŸ Ø§Ù„Ø®Ù…Ø³Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h4>
                    <div id="topStudentsList"></div>
                </div>
                <div class="list-card bottom-list">
                    <h4>âš ï¸ Ø¨Ø­Ø§Ø¬Ø© Ù„Ø¯Ø¹Ù… (Ø£Ù‚Ù„ 5)</h4>
                    <div id="bottomStudentsList"></div>
                </div>
            </div>
        </div>
        
        <div class="print-footer">
            <div style="flex:1; text-align:right;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…: ........................</div>
            <div class="designer-credit">ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: Ø£.Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø®Ù„Ù Ø§Ù„Ø±ÙˆØ§Ø­ÙŠ</div>
            <div style="flex:1; text-align:left;">ÙŠØ¹ØªÙ…Ø¯ØŒ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ........................</div>
        </div>
    </div>
</div>

<script>
    const SCHEMAS = {
        '5-9': { title: 'Ù†Ø¸Ø§Ù… 60 Ø¯Ø±Ø¬Ø©', total: 60, fields: [{ id: 'oral', label: 'Ø§Ù„Ø¹Ø±Ø¶<br>Ø§Ù„Ø´ÙÙˆÙŠ<br>(10)', max: 10 }, { id: 'q1', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(5)', max: 5 }, { id: 'q2', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(5)', max: 5 }, { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(15)', max: 15, isAnalysisKey: true }, { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(15)', max: 15 }, { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(10)', max: 10 }] },
        '10-11': { title: 'Ù†Ø¸Ø§Ù… 40 Ø¯Ø±Ø¬Ø©', total: 40, fields: [{ id: 'q1', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(5)', max: 5 }, { id: 'q2', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(5)', max: 5 }, { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(10)', max: 10, isAnalysisKey: true }, { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(10)', max: 10 }, { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(10)', max: 10 }] },
        '12': { title: 'Ù†Ø¸Ø§Ù… 30 Ø¯Ø±Ø¬Ø©', total: 30, fields: [{ id: 'shortQ', label: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©<br>Ø§Ù„Ù‚ØµÙŠØ±Ø©<br>(5)', max: 5 }, { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(10)', max: 10, isAnalysisKey: true }, { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(10)', max: 10 }, { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(5)', max: 5 }] }
    };

    let currentSchema = null;
    let currentSchemaKey = null;
    let editingIndex = -1;
    let chartInstance = null;
    let schoolData = {};
    let allGradesData = { "5-9": [], "10-11": [], "12": [] };

    window.onload = function() {
        initChart();
        loadAllData();
    };

    function loadAllData() {
        const sections = localStorage.getItem('school_sections_data');
        if (sections) {
            try { schoolData = JSON.parse(sections) || {}; } catch(e) { schoolData = {}; }
        } else {
            schoolData = {};
            ["5-9", "10-11", "12"].forEach(key => {
                const old = localStorage.getItem(`students_list_${key}`);
                if (old) schoolData[key] = { "Ø¹Ø§Ù…": old };
            });
        }

        const grades = localStorage.getItem('all_grades_data');
        if (grades) {
            try { allGradesData = JSON.parse(grades) || { "5-9": [], "10-11": [], "12": [] }; } 
            catch(e) { allGradesData = { "5-9": [], "10-11": [], "12": [] }; }
        }
    }

    function saveAllGradesToLocal() {
        localStorage.setItem('all_grades_data', JSON.stringify(allGradesData));
    }

    function downloadBackup() {
        const backup = {
            sections: schoolData,
            grades: allGradesData,
            timestamp: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(backup)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_geography_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function restoreBackup(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const backup = JSON.parse(e.target.result);
                if (backup.sections && backup.grades) {
                    schoolData = backup.sections;
                    allGradesData = backup.grades;
                    localStorage.setItem('school_sections_data', JSON.stringify(schoolData));
                    localStorage.setItem('all_grades_data', JSON.stringify(allGradesData));
                    showMsg("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...", "success");
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMsg("Ø®Ø·Ø£: Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­", "error");
                }
            } catch (err) {
                showMsg("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù", "error");
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
    function confirmClearData() {
        document.getElementById('clearDataModal').classList.add('active');
    }

    function performClear(type) {
        document.getElementById('clearDataModal').classList.remove('active');
        
        setTimeout(() => { // Timeout to allow modal to close before confirm alert
            if (type === 1) {
                if(confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø±ØµÙˆØ¯Ø© Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø©ØŸ")) {
                    allGradesData[currentSchemaKey] = [];
                    saveAllGradesToLocal();
                    renderTable();
                    showMsg("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", "success");
                }
            } else if (type === 2) {
                if(confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø©ØŸ")) {
                    delete schoolData[currentSchemaKey];
                    localStorage.setItem('school_sections_data', JSON.stringify(schoolData));
                    populateMainSectionSelect();
                    populateStudentSelect();
                    showMsg("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¨Ù†Ø¬Ø§Ø­", "success");
                }
            } else if (type === 3) {
                if(confirm("â›” ØªØ­Ø°ÙŠØ± Ø´Ø¯ÙŠØ¯: Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ (Ø§Ù„Ø¯Ø±Ø¬Ø§ØªØŒ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ØŒ Ø§Ù„Ø´Ø¹Ø¨) Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ØªÙ…Ø§Ù…Ø§Ù‹.\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø©ØŸ")) {
                    allGradesData[currentSchemaKey] = [];
                    delete schoolData[currentSchemaKey];
                    saveAllGradesToLocal();
                    localStorage.setItem('school_sections_data', JSON.stringify(schoolData));
                    renderTable();
                    populateMainSectionSelect();
                    populateStudentSelect();
                    showMsg("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­", "success");
                }
            }
        }, 100);
    }

    function changeSchema() {
        const select = document.getElementById('gradeSelect');
        const schemaKey = select.value;
        editingIndex = -1;
        currentSchemaKey = schemaKey;
        currentSchema = SCHEMAS[schemaKey];
        
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('workspace').classList.add('active');
        document.getElementById('backBtn').style.display = 'inline-flex';
        document.getElementById('sectionSelectorDiv').style.display = 'block';
        
        populateMainSectionSelect();
        renderInterface();
        renderTable();
    }

    function resetToMainMenu() {
        const tbody = document.getElementById('tableBody');
        if (tbody && tbody.children.length > 0) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŸ")) {
                return;
            }
        }
        currentSchema = null;
        currentSchemaKey = null;
        editingIndex = -1;
        studentCount = 0;
        document.getElementById('gradeSelect').value = "";
        
        const workspace = document.getElementById('workspace');
        if(workspace) workspace.classList.remove('active');
        
        const welcome = document.getElementById('welcomeScreen');
        if(welcome) welcome.style.display = 'flex';

        document.getElementById('backBtn').style.display = 'none';
        document.getElementById('sectionSelectorDiv').style.display = 'none';

        if(tbody) tbody.innerHTML = '';
        const emptyMsg = document.getElementById('emptyMsg');
        if(emptyMsg) emptyMsg.style.display = 'block';
        
        const inputContainer = document.getElementById('inputContainer');
        if(inputContainer) inputContainer.innerHTML = '';

        if (chartInstance) {
            chartInstance.data.datasets[0].data = [0, 0, 0, 0, 0];
            chartInstance.update();
            const analysis = document.getElementById('analysisSection');
            if(analysis) analysis.style.display = 'none';
        }
    }

    function populateMainSectionSelect() {
        const select = document.getElementById('mainSectionSelect');
        select.innerHTML = '<option value="">-- ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø¨ --</option>';
        if (schoolData && schoolData[currentSchemaKey]) {
            Object.keys(schoolData[currentSchemaKey]).forEach(sectionName => {
                const opt = document.createElement('option');
                opt.value = sectionName;
                opt.innerText = sectionName;
                select.appendChild(opt);
            });
        }
    }
    
    function filterStudentsBySection() {
        populateStudentSelect();
        renderTable();
    }

    function renderInterface() {
        if (!currentSchema) return;
        const container = document.getElementById('inputContainer');
        container.innerHTML = ''; 

        const nameDiv = document.createElement('div');
        nameDiv.className = 'form-group name-group';
        nameDiv.innerHTML = `
            <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <div style="display:flex; gap:5px; width:100%;">
                <select id="studentList" style="flex:1" onchange="checkExisting(this.value)">
                    <option value="">-- Ø§Ø®ØªØ± --</option>
                </select>
                <input type="text" id="manualName" placeholder="ÙŠØ¯ÙˆÙŠ" style="display:none; flex:1;" onblur="checkExisting(this.value)">
            </div>
            <small style="color:#3498db; cursor:pointer; margin-top:3px; font-size:0.7rem;" onclick="toggleNameInput()">ØªØ¨Ø¯ÙŠÙ„ (Ù‚Ø§Ø¦Ù…Ø©/ÙŠØ¯ÙˆÙŠ)</small>
        `;
        container.appendChild(nameDiv);

        currentSchema.fields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'form-group grade-group';
            div.innerHTML = `
                <label>${field.label}</label>
                <input type="number" id="${field.id}" min="0" max="${field.max}" step="0.5" placeholder="${field.max}">
            `;
            container.appendChild(div);
        });

        const btnDiv = document.createElement('div');
        btnDiv.className = 'form-group btn-group';
        btnDiv.innerHTML = `
            <label style="opacity:0;">Ø¥Ø¬Ø±Ø§Ø¡</label>
            <button id="actionBtn" class="btn btn-add" onclick="saveData()">+ Ø¥Ø¶Ø§ÙØ©</button>
        `;
        container.appendChild(btnDiv);

        const cancelDiv = document.createElement('div');
        cancelDiv.id = 'cancelEditInfo';
        cancelDiv.style.cssText = 'width:100%; text-align:center; display:none; color:#e67e22; cursor:pointer; margin-top:5px;';
        cancelDiv.innerHTML = 'â† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
        cancelDiv.onclick = clearForm;
        container.appendChild(cancelDiv);

        populateStudentSelect();
        
        const thead = document.getElementById('tableHead');
        let thHTML = `<tr><th>#</th><th style="text-align:right">Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>`;
        currentSchema.fields.forEach(f => { thHTML += `<th>${f.label}</th>`; });
        thHTML += `<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹<br>(${currentSchema.total})</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>`;
        thead.innerHTML = thHTML;
    }

    function populateStudentSelect() {
        if (!currentSchemaKey) return;
        const select = document.getElementById('studentList');
        if (!select) return;
        const mainSelect = document.getElementById('mainSectionSelect');
        const selectedSection = mainSelect ? mainSelect.value : "";
        const currentVal = select.value;
        
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>';
        
        if (schoolData && schoolData[currentSchemaKey]) {
            if (selectedSection && schoolData[currentSchemaKey][selectedSection]) {
                addOptionsFromText(select, schoolData[currentSchemaKey][selectedSection], selectedSection);
            } else {
                Object.keys(schoolData[currentSchemaKey]).forEach(sec => {
                    addOptionsFromText(select, schoolData[currentSchemaKey][sec], sec);
                });
            }
        }
        select.value = currentVal;
    }

    function addOptionsFromText(selectElement, text, sectionName) {
        if (!text) return;
        const lines = text.split('\n');
        const group = document.createElement('optgroup');
        group.label = sectionName;
        lines.forEach(l => {
            if (l.trim()) {
                const opt = document.createElement('option');
                opt.value = l.trim(); opt.innerText = l.trim();
                opt.dataset.section = sectionName;
                group.appendChild(opt);
            }
        });
        if (group.children.length > 0) selectElement.appendChild(group);
    }

    function saveData() {
        if (!currentSchema) return showMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø©', 'error');

        const listNameSelect = document.getElementById('studentList');
        const manualName = document.getElementById('manualName');
        let name = "";
        let section = "";

        if (manualName.style.display !== 'none' && manualName.value.trim()) {
            name = manualName.value.trim();
            section = document.getElementById('mainSectionSelect').value || "Ø¹Ø§Ù…";
        } else {
            name = listNameSelect.value;
            const selectedOption = listNameSelect.options[listNameSelect.selectedIndex];
            section = (selectedOption && selectedOption.dataset.section) ? selectedOption.dataset.section : (document.getElementById('mainSectionSelect').value || "Ø¹Ø§Ù…");
        }

        if (!name) return showMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');

        let scores = {};
        let total = 0;
        let exam1Score = 0;

        for (let field of currentSchema.fields) {
            const input = document.getElementById(field.id);
            let val = parseFloat(input.value) || 0;
            if (val < 0 || val > field.max) return showMsg(`Ø¯Ø±Ø¬Ø© ${field.label.replace(/<br>/g,' ')} ØºÙŠØ± ØµØ­ÙŠØ­Ø©`, 'error');
            scores[field.id] = val;
            total += val;
            if (field.isAnalysisKey) exam1Score = val;
        }

        const studentData = { name, section, scores, total, exam1Score };

        if (editingIndex > -1) {
            allGradesData[currentSchemaKey][editingIndex] = studentData;
            showMsg('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
            if (!allGradesData[currentSchemaKey]) allGradesData[currentSchemaKey] = [];
            allGradesData[currentSchemaKey].push(studentData);
            showMsg('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
        }

        saveAllGradesToLocal();
        clearForm();
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const emptyMsg = document.getElementById('emptyMsg');
        tbody.innerHTML = '';
        
        const data = allGradesData[currentSchemaKey] || [];
        const filterSection = document.getElementById('mainSectionSelect') ? document.getElementById('mainSectionSelect').value : "";
        
        let visibleCount = 0;
        let exam1Stats = [];
        let visibleStudents = [];

        data.forEach((student, index) => {
            if (filterSection && student.section !== filterSection) return;

            visibleCount++;
            if (typeof student.exam1Score !== 'undefined') exam1Stats.push(student.exam1Score);
            visibleStudents.push(student);

            const tr = document.createElement('tr');
            let html = `<td>${visibleCount}</td>
                        <td style="text-align:right; font-weight:bold;">${student.name}</td>
                        <td><span style="background:#ecf0f1; padding:2px 8px; border-radius:10px; font-size:0.8rem;">${student.section}</span></td>`;
            
            currentSchema.fields.forEach(f => {
                html += `<td>${student.scores[f.id]}</td>`;
            });
            
            html += `<td class="total-cell">${student.total}</td>
                     <td>
                        <button class="action-btn edit-btn" onclick="loadForEdit(${index})">âœ</button>
                        <button class="action-btn del-btn" onclick="deleteStudent(${index})">âœ•</button>
                     </td>`;
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        emptyMsg.style.display = visibleCount === 0 ? 'block' : 'none';
        updateAnalysis(exam1Stats);
        updateTopBottomLists(visibleStudents);
    }

    function loadForEdit(index) {
        editingIndex = index;
        const student = allGradesData[currentSchemaKey][index];
        toggleNameInput(true);
        document.getElementById('manualName').value = student.name;
        
        currentSchema.fields.forEach(f => {
            document.getElementById(f.id).value = student.scores[f.id];
        });

        document.getElementById('inputContainer').classList.add('edit-mode');
        document.getElementById('actionBtn').innerHTML = 'ğŸ’¾ Ø­ÙØ¸';
        document.getElementById('actionBtn').classList.add('update-mode');
        document.getElementById('cancelEditInfo').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteStudent(index) {
        if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
            allGradesData[currentSchemaKey].splice(index, 1);
            saveAllGradesToLocal();
            if(editingIndex === index) clearForm();
            renderTable();
        }
    }

    function clearForm() {
        editingIndex = -1;
        document.getElementById('studentList').value = "";
        document.getElementById('manualName').value = "";
        if(currentSchema) {
            currentSchema.fields.forEach(f => document.getElementById(f.id).value = "");
        }
        document.getElementById('inputContainer').classList.remove('edit-mode');
        document.getElementById('actionBtn').innerHTML = '+ Ø¥Ø¶Ø§ÙØ©';
        document.getElementById('actionBtn').classList.remove('update-mode');
        document.getElementById('cancelEditInfo').style.display = 'none';
    }

    function updateAnalysis(scores) {
        if (!currentSchema) return;
        const examField = currentSchema.fields.find(f => f.isAnalysisKey);
        if (!examField) return;
        const max = examField.max;
        
        let weak=0, acc=0, good=0, vgood=0, exc=0;
        let lowPerf = 0; // Ø§Ù„ØªØ¯Ù†ÙŠ
        let excellence = 0; // Ø§Ù„ØªÙÙˆÙ‚ (Ø¬ÙŠØ¯ Ø¬Ø¯Ø§ + Ù…Ù…ØªØ§Ø²)
        let hasData = scores.length > 0;

        scores.forEach(score => {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
            if (max === 15) {
                if (score < 7.5) weak++;
                else if (score < 9.75) acc++;
                else if (score < 12) good++;
                else if (score < 13.5) vgood++;
                else exc++;
            } else if (max === 10) {
                if (score < 5) weak++;
                else if (score < 6.5) acc++;
                else if (score < 8) good++;
                else if (score < 9) vgood++;
                else exc++;
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            if (score < 5) lowPerf++; // Ø§Ù„ØªØ¯Ù†ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø£Ù‚Ù„ Ù…Ù† 5
            
            // Ø§Ù„ØªÙÙˆÙ‚ (Ø¬ÙŠØ¯ Ø¬Ø¯Ø§ + Ù…Ù…ØªØ§Ø²)
            if (max === 15 && score >= 12) excellence++;
            if (max === 10 && score >= 8) excellence++;
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        const el = (id, val) => {
            const elem = document.getElementById(id);
            if (elem) elem.innerText = val;
        };
        
        el('cntWeak', weak); el('cntAcc', acc); el('cntGood', good); el('cntVGood', vgood); el('cntExc', exc);

        // ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨ Ø§Ù„Ø£Ø¯Ø§Ø¡
        if (hasData) {
            const total = scores.length;
            const lowPct = Math.round((lowPerf / total) * 100);
            const excPct = Math.round((excellence / total) * 100);
            el('lowRateVal', `${lowPct}%`);
            el('highRateVal', `${excPct}%`);
        } else {
            el('lowRateVal', `0%`);
            el('highRateVal', `0%`);
        }

        if(max === 15) {
            el('rangeWeak', 'Ø£Ù‚Ù„ Ù…Ù† 7.5'); el('rangeAcc', '7.5 Ø¥Ù„Ù‰ 9.74'); el('rangeGood', '9.75 Ø¥Ù„Ù‰ 11.9'); el('rangeVGood', '12 Ø¥Ù„Ù‰ 13.4'); el('rangeExc', '13.5 Ø¥Ù„Ù‰ 15');
        } else {
            el('rangeWeak', 'Ø£Ù‚Ù„ Ù…Ù† 5'); el('rangeAcc', '5 Ø¥Ù„Ù‰ 6.4'); el('rangeGood', '6.5 Ø¥Ù„Ù‰ 7.9'); el('rangeVGood', '8 Ø¥Ù„Ù‰ 8.9'); el('rangeExc', '9 Ø¥Ù„Ù‰ 10');
        }

        chartInstance.data.datasets[0].data = [weak, acc, good, vgood, exc];
        chartInstance.update();
        document.getElementById('analysisSection').style.display = hasData ? 'block' : 'none';
    }

    function updateTopBottomLists(students) {
        if (!students || students.length === 0) {
            document.getElementById('topStudentsList').innerHTML = '';
            document.getElementById('bottomStudentsList').innerHTML = '';
            return;
        }

        // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ (Ù„Ù„Ø£ÙˆØ§Ø¦Ù„)
        const sortedDesc = [...students].sort((a, b) => b.total - a.total);
        const top5 = sortedDesc.slice(0, 5);

        // ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ (Ù„Ù„Ù…ØªØ¹Ø«Ø±ÙŠÙ†)
        const sortedAsc = [...students].sort((a, b) => a.total - b.total);
        const bottom5 = sortedAsc.slice(0, 5);

        // Render Top 5
        let topHTML = '';
        top5.forEach(s => {
            topHTML += `<div class="student-item"><span>${s.name}</span><span class="student-score">${s.total}</span></div>`;
        });
        document.getElementById('topStudentsList').innerHTML = topHTML;

        // Render Bottom 5
        let bottomHTML = '';
        bottom5.forEach(s => {
            bottomHTML += `<div class="student-item"><span>${s.name}</span><span class="student-score">${s.total}</span></div>`;
        });
        document.getElementById('bottomStudentsList').innerHTML = bottomHTML;
    }

    function openNamesModal() {
        document.getElementById('classModal').classList.add('active');
        const modalSelect = document.getElementById('modalStageSelect');
        modalSelect.value = currentSchemaKey || "5-9";
        loadSectionsForModal();
    }

    function loadSectionsForModal() {
        const stage = document.getElementById('modalStageSelect').value;
        const listDiv = document.getElementById('modalSectionList');
        const nameInput = document.getElementById('modalSectionName');
        const textArea = document.getElementById('classListText');
        
        listDiv.innerHTML = '';
        textArea.value = '';
        nameInput.value = '';

        const newTag = document.createElement('div');
        newTag.className = 'section-tag new active';
        newTag.innerText = '+ Ø´Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©';
        newTag.onclick = () => selectModalSection(null, newTag);
        listDiv.appendChild(newTag);

        if (schoolData && schoolData[stage]) {
            Object.keys(schoolData[stage]).forEach(secName => {
                const tag = document.createElement('div');
                tag.className = 'section-tag';
                tag.innerText = secName;
                tag.onclick = () => selectModalSection(secName, tag);
                listDiv.appendChild(tag);
            });
        }
    }

    function selectModalSection(sectionName, element) {
        document.querySelectorAll('.section-tag').forEach(t => t.classList.remove('active'));
        element.classList.add('active');
        const stage = document.getElementById('modalStageSelect').value;
        const nameInput = document.getElementById('modalSectionName');
        const textArea = document.getElementById('classListText');

        if (sectionName) {
            nameInput.value = sectionName;
            textArea.value = (schoolData && schoolData[stage] && schoolData[stage][sectionName]) ? schoolData[stage][sectionName] : "";
        } else {
            nameInput.value = ""; textArea.value = ""; nameInput.focus();
        }
    }

    function saveSectionData() {
        const stage = document.getElementById('modalStageSelect').value;
        const sectionName = document.getElementById('modalSectionName').value.trim();
        const text = document.getElementById('classListText').value;

        if (!sectionName) return showMsg("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©", "error");

        if (!schoolData) schoolData = {};
        if (!schoolData[stage]) schoolData[stage] = {};
        
        schoolData[stage][sectionName] = text;
        localStorage.setItem('school_sections_data', JSON.stringify(schoolData));
        
        showMsg(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø¨Ø© "${sectionName}"`, "success");
        loadSectionsForModal();
        if (currentSchemaKey === stage) {
            populateMainSectionSelect();
            populateStudentSelect();
        }
    }

    function checkExisting(val) {
        if(!val || !allGradesData[currentSchemaKey]) return;
        const idx = allGradesData[currentSchemaKey].findIndex(s => s.name === val.trim());
        if (idx > -1) {
            loadForEdit(idx);
            showMsg(`Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ "${val}"`, 'info');
        }
    }

    function toggleNameInput(forceManual) {
        const list = document.getElementById('studentList');
        const manual = document.getElementById('manualName');
        if (typeof forceManual === 'boolean') {
            if (forceManual) { list.style.display = 'none'; manual.style.display = 'block'; }
            else { list.style.display = 'block'; manual.style.display = 'none'; }
        } else {
            if (list.style.display !== 'none') { list.style.display = 'none'; manual.style.display = 'block'; manual.focus(); }
            else { list.style.display = 'block'; manual.style.display = 'none'; list.focus(); }
        }
    }

    function showMsg(txt, type) {
        const area = document.getElementById('notification-area');
        const d = document.createElement('div');
        d.className = `notification ${type}`;
        d.innerText = txt;
        area.appendChild(d);
        setTimeout(() => d.classList.add('show'), 10);
        setTimeout(() => { d.classList.remove('show'); setTimeout(()=>d.remove(), 300); }, 3000);
    }

    function initChart() {
        const ctx = document.getElementById('analysisChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ø¶Ø¹ÙŠÙ', 'Ù…Ù‚Ø¨ÙˆÙ„', 'Ø¬ÙŠØ¯', 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹', 'Ù…Ù…ØªØ§Ø²'],
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨',
                    data: [0,0,0,0,0],
                    backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#1abc9c', '#2ecc71']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    function printAnalysisOnly() {
        document.body.classList.add('print-analysis-only');
        window.print();
        document.body.classList.remove('print-analysis-only');
    }

    function exportToExcel() {
        const table = document.getElementById("gradesTable");
        let clone = table.cloneNode(true);
        for (let row of clone.rows) { row.deleteCell(-1); }
        let html = clone.outerHTML;
        const blob = new Blob(['\ufeff' + html], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Ø³Ø¬Ù„_Ø§Ù„Ø¯Ø±Ø¬Ø§Øª_${new Date().toLocaleDateString()}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>