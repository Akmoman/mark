<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ - Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙØ§ØªØ­Ø© */
            --primary: #2c3e50;       /* Ø£Ø²Ø±Ù‚ ØºØ§Ù…Ù‚ */
            --primary-light: #ecf0f1; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ */
            --accent: #27ae60;        /* Ø£Ø®Ø¶Ø± Ù‡Ø§Ø¯Ø¦ */
            --bg-color: #f4f7f6;      
            --white: #ffffff;
            --text-dark: #2c3e50;     
            --border: #dfe6e9;        
            --error: #e74c3c;         
            --warning: #f39c12;       
            --info: #3498db;          
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            overflow: hidden;
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        #landingPage {
            padding: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            background: linear-gradient(to bottom, #fff, #f9fbfd);
        }

        .landing-header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .landing-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 900px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            transition: transform 0.3s;
        }
        .feature-card:hover { transform: translateY(-5px); }
        .feature-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .feature-title { font-weight: bold; color: var(--primary); margin-bottom: 5px; display: block;}
        .feature-desc { font-size: 0.9rem; color: #636e72; }

        .start-section {
            background: var(--primary-light);
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .designer-info {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #95a5a6;
            font-size: 0.9rem;
            width: 100%;
        }
        .designer-name { color: var(--accent); font-weight: bold; }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ --- */
        .workspace-toolbar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .toolbar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .toolbar-section-left { display: flex; gap: 10px; flex-wrap: wrap; }
        .toolbar-section-right { display: flex; gap: 10px; flex-wrap: wrap; margin-right: auto; }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… */
        select {
            padding: 8px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            background: white;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn:hover { opacity: 0.9; }

        .btn-primary { background-color: var(--primary); }
        .btn-accent { background-color: var(--accent); }
        .btn-danger { background-color: var(--error); }
        .btn-warning { background-color: var(--warning); color: #2d3436; }
        .btn-info { background-color: var(--info); }
        .btn-purple { background-color: #9b59b6; }
        .btn-dark { background-color: #34495e; }
        
        .workspace { display: none; flex-direction: column; }
        .workspace.active { display: flex; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .input-section {
            padding: 20px;
            background-color: #fff;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            justify-content: center;
            border-bottom: 1px solid #eee;
        }
        .input-section.edit-mode { background-color: #fffbf0; border-bottom: 2px solid var(--warning); }

        .form-group { display: flex; flex-direction: column; align-items: center; }
        .form-group label { font-size: 0.8rem; margin-bottom: 5px; font-weight: bold; color: #7f8c8d; text-align: center; min-height: 40px; display: flex; align-items: flex-end; justify-content: center; }
        .form-group input, .form-group select { width: 100%; min-width: 80px; text-align: center; }
        .name-input { min-width: 200px; flex-grow: 2; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        thead { background-color: #ecf0f1; color: #2c3e50; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; }
        .total-cell { font-weight: bold; color: var(--primary); }

        /* Ø§Ù„ØªØ­Ù„ÙŠÙ„ */
        .analysis-section { padding: 30px; border-top: 1px solid #eee; display: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .stat-val { font-size: 1.8rem; font-weight: bold; color: var(--text-dark); }
        .rates-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .rate-card { padding: 15px; border-radius: 8px; text-align: center; border: 1px solid; }
        .rate-card.red { background: #fff5f5; border-color: #ff7675; color: #c0392b; }
        .rate-card.green { background: #f0fdf4; border-color: #00b894; color: #27ae60; }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .lists-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .list-box { border: 1px solid #eee; border-radius: 8px; padding: 15px; }
        .list-box h4 { margin-top: 0; border-bottom: 2px solid; padding-bottom: 10px; margin-bottom: 10px; }
        .student-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f9f9f9; }
        
        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        #notification-area { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .notif { padding: 10px 20px; border-radius: 5px; color: white; margin-bottom: 5px; opacity: 0; transition: 0.3s; transform: translateY(-20px); }
        .notif.show { opacity: 1; transform: translateY(0); }
        .notif.success { background: var(--accent); } .notif.error { background: var(--error); } .notif.info { background: var(--info); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1500; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 500px; max-width: 95%; max-height: 90vh; overflow-y: auto; }
        textarea { width: 100%; height: 150px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        .modal-section-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .section-tag { background: #f1f2f6; padding: 6px 16px; border-radius: 20px; cursor: pointer; white-space: nowrap; border: 1px solid #dfe6e9; color: #636e72; }
        .section-tag.active { background: var(--primary); color: white; border-color: var(--primary); }
        .section-tag.new { border-style: dashed; background: white; }

        /* Print */
        @media print {
            @page { size: landscape; margin: 0.5cm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .container { box-shadow: none; border: none; margin: 0; width: 100%; max-width: 100%; }
            #landingPage, .workspace-toolbar, .input-section, .btn, .action-btn, #notification-area, .modal { display: none !important; }
            .workspace { display: block !important; }
            .print-header { display: block !important; text-align: center; border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 10px; }
            .table-wrapper { overflow: visible; }
            table { border: 1px solid #000; width: 100%; font-size: 10pt; }
            th, td { border: 1px solid #000; padding: 4px; color: black; }
            thead { background-color: #eee !important; color: black !important; }
            th:last-child, td:last-child { display: none; }
            .analysis-section { display: block !important; page-break-inside: avoid; border: 1px solid #ccc; margin-top: 20px; padding: 10px; }
            .chart-wrapper { height: 200px; }
            .print-footer { display: flex !important; justify-content: space-between; margin-top: 30px; padding-top: 10px; border-top: 1px solid #ccc; }
        }
        .print-header, .print-footer { display: none; }
    </style>
</head>
<body>

<div id="notification-area"></div>
<input type="file" id="restoreFileInput" style="display:none;" accept=".json" onchange="restoreBackup(this)">

<div class="container">
    
    <!-- 1. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Landing Page) -->
    <div id="landingPage">
        <div class="landing-header">
            <h1>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h1>
            <p>Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</p>
        </div>

        <div class="features-grid">
            <div class="feature-card">
                <span class="feature-icon">ğŸ“Š</span>
                <span class="feature-title">ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
                <span class="feature-desc">Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© ÙˆÙ†Ø³Ø¨ Ù…Ø¦ÙˆÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨.</span>
            </div>
            <div class="feature-card">
                <span class="feature-icon">ğŸ’¾</span>
                <span class="feature-title">Ø­ÙØ¸ Ø¢Ù…Ù†</span>
                <span class="feature-desc">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ.</span>
            </div>
            <div class="feature-card">
                <span class="feature-icon">ğŸ‘¥</span>
                <span class="feature-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø¨</span>
                <span class="feature-desc">ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø´Ø¹Ø¨ Ù…ØªØ¹Ø¯Ø¯Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©.</span>
            </div>
            <div class="feature-card">
                <span class="feature-icon">ğŸ–¨ï¸</span>
                <span class="feature-title">Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø§Ø±ÙŠØ±</span>
                <span class="feature-desc">ØªÙ‚Ø§Ø±ÙŠØ± Ø¬Ø§Ù‡Ø²Ø© ÙˆÙ…Ù†Ø³Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØ±Ù‚ÙŠØ©.</span>
            </div>
        </div>

        <div class="start-section">
            <label style="display:block; margin-bottom:10px; font-size:1.1rem; color:var(--primary);">ğŸ‘‡ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
            <select id="landingGradeSelect" onchange="startApp(this.value)" style="width:100%; padding:12px; font-size:1.1rem; border:2px solid var(--accent);">
                <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
                <optgroup label="Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©">
                    <option value="5-9">Ø§Ù„ØµÙÙˆÙ (5 - 9)</option>
                </optgroup>
                <optgroup label="Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ">
                    <option value="10-11">Ø§Ù„ØµÙÙˆÙ (10 - 11)</option>
                    <option value="12">Ø§Ù„ØµÙ (12)</option>
                </optgroup>
            </select>
        </div>

        <div class="designer-info">
            ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: <span class="designer-name">Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø®Ù„Ù Ø§Ù„Ø±ÙˆØ§Ø­ÙŠ</span>
        </div>
    </div>

    <!-- 2. Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (Workspace) -->
    <div id="workspace" class="workspace">
        
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
        <div class="workspace-toolbar">
            <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø¬ÙˆØ¹ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© -->
            <div class="toolbar-row">
                <div class="toolbar-section-left">
                    <button class="btn btn-danger" onclick="returnToMain()">ğŸ  Ø®Ø±ÙˆØ¬ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <span style="font-weight:bold; color:var(--primary); font-size:1.1rem; padding:0 10px; border-right:2px solid #ddd;" id="currentStageLabel"></span>
                </div>
                
                <div class="toolbar-section-right">
                     <select id="sectionSelect" onchange="filterBySection()" style="min-width:150px;">
                        <option value="">-- ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø¨ --</option>
                    </select>
                </div>
            </div>

            <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
            <div class="toolbar-row">
                <div class="toolbar-section-left">
                    <button class="btn btn-purple" onclick="downloadBackup()">ğŸ“¥ Ø­ÙØ¸ Ù†Ø³Ø®Ø©</button>
                    <button class="btn btn-primary" onclick="document.getElementById('restoreFileInput').click()">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                    <button class="btn btn-warning" onclick="openClearModal()">ğŸ—‘ï¸ ØªØµÙÙŠØ©</button>
                </div>
            </div>

            <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù„Ø«: Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
            <div class="toolbar-row">
                <div class="toolbar-section-left">
                     <button class="btn btn-info" onclick="openNamesModal()">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø´Ø¹Ø¨</button>
                </div>
                <div class="toolbar-section-right">
                    <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button class="btn btn-accent" onclick="exportToExcel()">ğŸ“Š Excel</button>
                </div>
            </div>
        </div>

        <!-- Ù‡ÙŠØ¯Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ÙÙŠ -->
        <div class="print-header">
            <h1>Ø³Ø¬Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</h1>
            <p id="printPageSubHeader"></p>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
        <div id="inputContainer" class="input-section"></div>

        <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
        <div class="table-wrapper">
            <table id="gradesTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div id="emptyMsg" style="text-align: center; padding: 30px; color: #bdc3c7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>
        </div>

        <!-- Ø§Ù„ØªØ­Ù„ÙŠÙ„ -->
        <div id="analysisSection" class="analysis-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; color:var(--primary);">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                <button class="btn btn-dark" onclick="printAnalysisOnly()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙ‚Ø·</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card" style="border-bottom-color:#e74c3c"><h5>Ø¶Ø¹ÙŠÙ</h5><div id="statWeak" class="stat-val" style="color:#e74c3c">0</div></div>
                <div class="stat-card" style="border-bottom-color:#f39c12"><h5>Ù…Ù‚Ø¨ÙˆÙ„</h5><div id="statAcc" class="stat-val" style="color:#f39c12">0</div></div>
                <div class="stat-card" style="border-bottom-color:#3498db"><h5>Ø¬ÙŠØ¯</h5><div id="statGood" class="stat-val" style="color:#3498db">0</div></div>
                <div class="stat-card" style="border-bottom-color:#1abc9c"><h5>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</h5><div id="statVGood" class="stat-val" style="color:#1abc9c">0</div></div>
                <div class="stat-card" style="border-bottom-color:#2ecc71"><h5>Ù…Ù…ØªØ§Ø²</h5><div id="statExc" class="stat-val" style="color:#2ecc71">0</div></div>
            </div>

            <div class="rates-grid">
                <div class="rate-card red">
                    <h5>âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯Ù†ÙŠ (< 5)</h5>
                    <div class="stat-val" id="rateLow">0%</div>
                </div>
                <div class="rate-card green">
                    <h5>ğŸŒŸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙÙˆÙ‚ (Ø£ØŒ Ø¨)</h5>
                    <div class="stat-val" id="rateHigh">0%</div>
                </div>
            </div>

            <div class="chart-wrapper"><canvas id="analysisChart"></canvas></div>

            <div class="lists-container">
                <div class="list-box" style="border-color:#2ecc71">
                    <h4 style="color:#27ae60; border-color:#2ecc71">ğŸŒŸ Ø§Ù„Ø®Ù…Ø³Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h4>
                    <div id="topList"></div>
                </div>
                <div class="list-box" style="border-color:#e74c3c">
                    <h4 style="color:#c0392b; border-color:#e74c3c">âš ï¸ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h4>
                    <div id="bottomList"></div>
                </div>
            </div>
        </div>

        <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
        <div class="print-footer">
            <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…: ........................</div>
            <div>ÙŠØ¹ØªÙ…Ø¯ØŒ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ........................</div>
        </div>
    </div>
</div>

<!-- Modal: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø§Ù„Ù…ØµØ­Ø­) -->
<div id="namesModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø¨ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡</h3>
        
        <!-- ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù‡Ù†Ø§ Ù„Ù„Ø¥ØµÙ„Ø§Ø­ -->
        <div class="form-group" style="align-items: flex-start; margin-bottom: 10px;">
            <label style="margin-bottom: 5px;">Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</label>
            <select id="modalStageSelect" onchange="loadSectionsForModal()" style="width: 100%;">
                <option value="5-9">Ø§Ù„ØµÙÙˆÙ (5 - 9)</option>
                <option value="10-11">Ø§Ù„ØµÙÙˆÙ (10 - 11)</option>
                <option value="12">Ø§Ù„ØµÙ (12)</option>
            </select>
        </div>
        
        <div style="margin-bottom:15px;">
            <label style="display:block; font-weight:bold; margin-bottom:5px;">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£Ùˆ Ø§ÙƒØªØ¨ Ø¬Ø¯ÙŠØ¯Ø©:</label>
            <div id="modalSectionList" class="modal-section-list"></div>
            <input type="text" id="modalSectionName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© (Ù…Ø«Ø§Ù„: 5/1)" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-top:5px;">
        </div>

        <label style="display:block; font-weight:bold; margin-bottom:5px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±):</label>
        <textarea id="modalNamesText"></textarea>
        
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:15px;">
            <button class="btn btn-accent" onclick="saveSectionNames()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            <button class="btn btn-danger" onclick="closeModal('namesModal')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<!-- Modal: Ø§Ù„ØªØµÙÙŠØ© -->
<div id="clearModal" class="modal">
    <div class="modal-content" style="max-width:400px; text-align:center;">
        <h3 style="color:var(--error); margin-top:0;">âš ï¸ ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡Ø§ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</p>
        <div style="display:flex; flex-direction:column; gap:10px; margin:20px 0;">
            <button class="btn btn-warning" onclick="executeClear(1)">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙÙ‚Ø·</button>
            <button class="btn btn-warning" onclick="executeClear(2)">ğŸ“‹ Ù…Ø³Ø­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø´Ø¹Ø¨</button>
            <button class="btn btn-danger" onclick="executeClear(3)">ğŸ”¥ Ù…Ø³Ø­ Ø´Ø§Ù…Ù„ (Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·)</button>
        </div>
        <button class="btn btn-dark" onclick="closeModal('clearModal')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script>
    // --- Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª ---
    const SCHEMAS = {
        '5-9': { name: 'Ø§Ù„ØµÙÙˆÙ (5-9)', total: 60, fields: [
            { id: 'oral', label: 'Ø§Ù„Ø¹Ø±Ø¶<br>Ø§Ù„Ø´ÙÙˆÙŠ<br>(10)', max: 10 },
            { id: 'q1', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(5)', max: 5 },
            { id: 'q2', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(5)', max: 5 },
            { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(15)', max: 15, isKey: true },
            { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(15)', max: 15 },
            { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(10)', max: 10 }
        ]},
        '10-11': { name: 'Ø§Ù„ØµÙÙˆÙ (10-11)', total: 40, fields: [
            { id: 'q1', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(5)', max: 5 },
            { id: 'q2', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(5)', max: 5 },
            { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(10)', max: 10, isKey: true },
            { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(10)', max: 10 },
            { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(10)', max: 10 }
        ]},
        '12': { name: 'Ø§Ù„ØµÙ (12)', total: 30, fields: [
            { id: 'shortQ', label: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©<br>Ø§Ù„Ù‚ØµÙŠØ±Ø©<br>(5)', max: 5 },
            { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(10)', max: 10, isKey: true },
            { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(10)', max: 10 },
            { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(5)', max: 5 }
        ]}
    };

    let currentKey = null;
    let editIndex = -1;
    let chartObj = null;
    
    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ­ÙØ¸ ÙÙŠ LocalStorage)
    let dbSections = {}; // { '5-9': { '5/1': 'names...' } }
    let dbGrades = { '5-9': [], '10-11': [], '12': [] };

    // --- Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ---
    window.onload = () => {
        loadData();
        initChart();
    };

    function loadData() {
        const sec = localStorage.getItem('ss_sections');
        const grd = localStorage.getItem('ss_grades');
        
        if(sec) {
            try { dbSections = JSON.parse(sec); } catch(e) { dbSections = {}; }
        } else {
            dbSections = {};
            ["5-9", "10-11", "12"].forEach(k => {
                const old = localStorage.getItem(`students_list_${k}`);
                if(old) dbSections[k] = { "Ø¹Ø§Ù…": old };
            });
        }

        if(grd) {
            try { dbGrades = JSON.parse(grd); } catch(e) { dbGrades = { '5-9': [], '10-11': [], '12': [] }; }
        } else {
             const oldG = localStorage.getItem('all_grades_data');
             if(oldG) try { dbGrades = JSON.parse(oldG); } catch(e){}
        }
    }

    function saveData() {
        localStorage.setItem('ss_sections', JSON.stringify(dbSections));
        localStorage.setItem('ss_grades', JSON.stringify(dbGrades));
    }

    // --- Ø§Ù„ØªÙ†Ù‚Ù„ ---
    function startApp(key) {
        currentKey = key;
        document.getElementById('landingPage').style.display = 'none';
        document.getElementById('workspace').classList.add('active');
        
        document.getElementById('currentStageLabel').innerText = SCHEMAS[key].name;
        document.getElementById('printPageSubHeader').innerText = SCHEMAS[key].name;
        
        updateSectionDropdown();
        buildInputForm();
        renderTable();
    }

    function returnToMain() {
        currentKey = null;
        editIndex = -1;
        document.getElementById('landingGradeSelect').value = "";
        document.getElementById('workspace').classList.remove('active');
        document.getElementById('landingPage').style.display = 'flex';
    }

    // --- Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    function buildInputForm() {
        const schema = SCHEMAS[currentKey];
        const container = document.getElementById('inputContainer');
        container.innerHTML = '';

        // Ø§Ù„Ø§Ø³Ù…
        const nameGroup = document.createElement('div');
        nameGroup.className = 'form-group name-input';
        nameGroup.innerHTML = `
            <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <div style="display:flex; width:100%; gap:5px;">
                <select id="in_list" style="flex:1" onchange="fillName(this.value)">
                    <option value="">-- Ø§Ø®ØªØ± --</option>
                </select>
                <input type="text" id="in_manual" placeholder="ÙŠØ¯ÙˆÙŠ" style="display:none; flex:1;">
            </div>
            <small style="cursor:pointer; color:var(--info)" onclick="toggleInputMode()">ØªØ¨Ø¯ÙŠÙ„ (Ù‚Ø§Ø¦Ù…Ø©/ÙŠØ¯ÙˆÙŠ)</small>
        `;
        container.appendChild(nameGroup);

        // Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
        schema.fields.forEach(f => {
            const grp = document.createElement('div');
            grp.className = 'form-group';
            grp.innerHTML = `
                <label>${f.label}</label>
                <input type="number" id="in_${f.id}" min="0" max="${f.max}" step="0.5" placeholder="${f.max}">
            `;
            container.appendChild(grp);
        });

        // Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        const btnGroup = document.createElement('div');
        btnGroup.className = 'form-group';
        btnGroup.innerHTML = `
            <label style="visibility:hidden">.</label>
            <button id="mainActionBtn" class="btn btn-accent" onclick="submitGrade()">+ Ø¥Ø¶Ø§ÙØ©</button>
            <small id="cancelEditLink" style="display:none; cursor:pointer; color:var(--error); margin-top:5px;" onclick="cancelEdit()">Ø¥Ù„ØºØ§Ø¡</small>
        `;
        container.appendChild(btnGroup);

        fillStudentList();
    }

    function updateSectionDropdown() {
        const sel = document.getElementById('sectionSelect');
        sel.innerHTML = '<option value="">-- ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø¨ --</option>';
        if(dbSections[currentKey]) {
            Object.keys(dbSections[currentKey]).forEach(sec => {
                const opt = document.createElement('option');
                opt.value = sec; opt.innerText = sec;
                sel.appendChild(opt);
            });
        }
    }

    function fillStudentList() {
        const sel = document.getElementById('in_list');
        const filter = document.getElementById('sectionSelect').value;
        sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>';

        if(!dbSections[currentKey]) return;

        if(filter) {
            if(dbSections[currentKey][filter]) {
                addOpts(sel, dbSections[currentKey][filter], filter);
            }
        } else {
            Object.keys(dbSections[currentKey]).forEach(sec => {
                addOpts(sel, dbSections[currentKey][sec], sec);
            });
        }
    }

    function addOpts(sel, text, secName) {
        if(!text) return;
        const grp = document.createElement('optgroup');
        grp.label = secName;
        text.split('\n').forEach(name => {
            if(name.trim()) {
                const o = document.createElement('option');
                o.value = name.trim(); o.innerText = name.trim();
                o.dataset.sec = secName;
                grp.appendChild(o);
            }
        });
        sel.appendChild(grp);
    }

    function toggleInputMode(forceManual) {
        const lst = document.getElementById('in_list');
        const man = document.getElementById('in_manual');
        if(forceManual || lst.style.display !== 'none') {
            lst.style.display = 'none'; man.style.display = 'block'; man.focus();
        } else {
            lst.style.display = 'block'; man.style.display = 'none';
        }
    }

    function fillName(val) {}

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ---
    function submitGrade() {
        const schema = SCHEMAS[currentKey];
        const listIn = document.getElementById('in_list');
        const manIn = document.getElementById('in_manual');
        
        let name = manIn.style.display !== 'none' ? manIn.value : listIn.value;
        if(!name) return showNotif("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨", "error");

        let section = "Ø¹Ø§Ù…";
        if(manIn.style.display === 'none' && listIn.selectedOptions[0]) {
            section = listIn.selectedOptions[0].dataset.sec || "Ø¹Ø§Ù…";
        } else {
            section = document.getElementById('sectionSelect').value || "Ø¹Ø§Ù…";
        }

        let scores = {};
        let total = 0;
        let keyScore = 0;

        for(let f of schema.fields) {
            let val = parseFloat(document.getElementById('in_'+f.id).value) || 0;
            if(val > f.max) return showNotif(`Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙŠ ${f.label.replace(/<br>/g,' ')} Ø£ÙƒØ¨Ø± Ù…Ù† ${f.max}`, 'error');
            scores[f.id] = val;
            total += val;
            if(f.isKey) keyScore = val;
        }

        const record = { name, section, scores, total, keyScore };

        if(editIndex > -1) {
            dbGrades[currentKey][editIndex] = record;
            showNotif("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "success");
        } else {
            if(!dbGrades[currentKey]) dbGrades[currentKey] = [];
            dbGrades[currentKey].push(record);
            showNotif("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©", "success");
        }

        saveData();
        cancelEdit();
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const schema = SCHEMAS[currentKey];
        const filter = document.getElementById('sectionSelect').value;
        
        const headerRow = document.getElementById('tableHead');
        let hHtml = `<tr><th>#</th><th style="text-align:right">Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>`;
        schema.fields.forEach(f => hHtml += `<th>${f.label}</th>`);
        hHtml += `<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹<br>(${schema.total})</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>`;
        headerRow.innerHTML = hHtml;

        let data = dbGrades[currentKey] || [];
        let visibleData = [];
        let counter = 1;

        data.forEach((item, idx) => {
            if(filter && item.section !== filter) return;
            visibleData.push(item);
            
            const tr = document.createElement('tr');
            let html = `<td>${counter++}</td><td style="text-align:right; font-weight:bold;">${item.name}</td><td>${item.section}</td>`;
            
            schema.fields.forEach(f => {
                html += `<td>${item.scores[f.id]}</td>`;
            });

            html += `<td class="total-cell">${item.total}</td>
            <td>
                <button class="action-btn edit-btn" onclick="editItem(${idx})">âœ</button>
                <button class="action-btn del-btn" onclick="deleteItem(${idx})">âœ•</button>
            </td>`;
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        document.getElementById('emptyMsg').style.display = visibleData.length ? 'none' : 'block';
        updateAnalysis(visibleData);
    }

    function editItem(idx) {
        editIndex = idx;
        const item = dbGrades[currentKey][idx];
        const schema = SCHEMAS[currentKey];

        toggleInputMode(true);
        document.getElementById('in_manual').value = item.name;
        
        schema.fields.forEach(f => {
            document.getElementById('in_'+f.id).value = item.scores[f.id];
        });

        const btn = document.getElementById('mainActionBtn');
        btn.innerText = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
        btn.className = "btn btn-warning";
        document.getElementById('inputContainer').classList.add('edit-mode');
        document.getElementById('cancelEditLink').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function cancelEdit() {
        editIndex = -1;
        document.getElementById('in_manual').value = '';
        document.getElementById('in_list').value = '';
        const schema = SCHEMAS[currentKey];
        schema.fields.forEach(f => document.getElementById('in_'+f.id).value = '');
        
        const btn = document.getElementById('mainActionBtn');
        btn.innerText = "+ Ø¥Ø¶Ø§ÙØ©";
        btn.className = "btn btn-accent";
        document.getElementById('inputContainer').classList.remove('edit-mode');
        document.getElementById('cancelEditLink').style.display = 'none';
    }

    function deleteItem(idx) {
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
            dbGrades[currentKey].splice(idx, 1);
            saveData();
            if(editIndex === idx) cancelEdit();
            renderTable();
        }
    }

    function filterBySection() {
        fillStudentList();
        renderTable();
    }

    // --- Ø§Ù„ØªØ­Ù„ÙŠÙ„ ---
    function updateAnalysis(data) {
        const section = document.getElementById('analysisSection');
        if(data.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = 'block';

        const max = SCHEMAS[currentKey].fields.find(f => f.isKey).max;
        let counts = [0,0,0,0,0]; 
        let low = 0, high = 0;

        data.forEach(d => {
            let s = d.keyScore || 0;
            if(max === 15) {
                if(s < 7.5) counts[0]++; else if(s < 9.75) counts[1]++; else if(s < 12) counts[2]++; else if(s < 13.5) counts[3]++; else counts[4]++;
            } else {
                if(s < 5) counts[0]++; else if(s < 6.5) counts[1]++; else if(s < 8) counts[2]++; else if(s < 9) counts[3]++; else counts[4]++;
            }

            if(s < 5) low++;
            if((max===15 && s>=12) || (max===10 && s>=8)) high++;
        });

        ['Weak','Acc','Good','VGood','Exc'].forEach((k, i) => document.getElementById('stat'+k).innerText = counts[i]);
        document.getElementById('rateLow').innerText = Math.round((low/data.length)*100) + "%";
        document.getElementById('rateHigh').innerText = Math.round((high/data.length)*100) + "%";

        chartObj.data.datasets[0].data = counts;
        chartObj.update();
        updateLists(data);
    }

    function updateLists(data) {
        const sorted = [...data].sort((a,b) => b.total - a.total);
        const top = sorted.slice(0, 5);
        const bottom = [...sorted].reverse().slice(0, 5);
        const renderList = (arr, elId) => {
            document.getElementById(elId).innerHTML = arr.map(i => `<div class="student-row"><span>${i.name}</span><b>${i.total}</b></div>`).join('');
        };
        renderList(top, 'topList');
        renderList(bottom, 'bottomList');
    }

    function initChart() {
        const ctx = document.getElementById('analysisChart').getContext('2d');
        chartObj = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ø¶Ø¹ÙŠÙ', 'Ù…Ù‚Ø¨ÙˆÙ„', 'Ø¬ÙŠØ¯', 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹', 'Ù…Ù…ØªØ§Ø²'],
                datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨', data: [0,0,0,0,0], backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#1abc9c', '#2ecc71'] }]
            },
            options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{stepSize:1} } } }
        });
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„ ---
    function openNamesModal() {
        document.getElementById('namesModal').classList.add('active');
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        const sel = document.getElementById('modalStageSelect');
        if(currentKey) {
            sel.value = currentKey;
        } else {
            sel.value = "5-9"; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
        }
        
        loadSectionsForModal();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function loadSectionsForModal() {
        const stage = document.getElementById('modalStageSelect').value;
        const div = document.getElementById('modalSectionList');
        div.innerHTML = '';
        
        if(dbSections[stage]) {
            Object.keys(dbSections[stage]).forEach(sec => {
                const btn = document.createElement('div');
                btn.className = 'section-tag';
                btn.innerText = sec;
                btn.onclick = () => loadSectionEdit(sec);
                div.appendChild(btn);
            });
        }
    }

    function loadSectionEdit(secName) {
        const stage = document.getElementById('modalStageSelect').value;
        document.getElementById('modalSectionName').value = secName;
        document.getElementById('modalNamesText').value = dbSections[stage][secName];
    }

    function saveSectionNames() {
        const stage = document.getElementById('modalStageSelect').value;
        const sec = document.getElementById('modalSectionName').value.trim();
        const txt = document.getElementById('modalNamesText').value;
        if(!sec) return showNotif("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©", "error");
        
        if(!dbSections[stage]) dbSections[stage] = {};
        dbSections[stage][sec] = txt;
        saveData();
        
        showNotif("ØªÙ… Ø§Ù„Ø­ÙØ¸", "success");
        loadSectionsForModal();
        if(stage === currentKey) { updateSectionDropdown(); fillStudentList(); }
    }

    // Ø§Ù„ØªØµÙÙŠØ©
    function openClearModal() { document.getElementById('clearModal').classList.add('active'); }
    function executeClear(type) {
        closeModal('clearModal');
        setTimeout(() => {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) return;
            
            if(type === 1 || type === 3) dbGrades[currentKey] = [];
            if(type === 2 || type === 3) delete dbSections[currentKey];
            
            saveData();
            if(currentKey) { updateSectionDropdown(); fillStudentList(); renderTable(); }
            showNotif("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­", "success");
        }, 100);
    }

    // Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    function downloadBackup() {
        const data = { s: dbSections, g: dbGrades, date: new Date() };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'SocialStudies_Backup.json';
        a.click();
    }

    function restoreBackup(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                const d = JSON.parse(e.target.result);
                if(d.s && d.g) {
                    dbSections = d.s; dbGrades = d.g;
                    saveData();
                    alert("ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");
                    location.reload();
                }
            } catch(err) { alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­"); }
        };
        r.readAsText(file);
    }

    function showNotif(msg, type) {
        const area = document.getElementById('notification-area');
        const d = document.createElement('div');
        d.className = `notif ${type}`;
        d.innerText = msg;
        area.appendChild(d);
        setTimeout(() => d.classList.add('show'), 10);
        setTimeout(() => d.remove(), 3000);
    }

    function exportToExcel() {
        const tbl = document.getElementById('gradesTable');
        const html = tbl.outerHTML.replace(/ /g, '%20');
        const a = document.createElement('a');
        a.href = 'data:application/vnd.ms-excel,' + html;
        a.download = 'Grades.xls';
        a.click();
    }
    
    function printAnalysisOnly() {
        document.body.classList.add('print-analysis-only');
        window.print();
        document.body.classList.remove('print-analysis-only');
    }
</script>
</body>
</html>