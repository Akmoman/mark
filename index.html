<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ - Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙØ§ØªØ­Ø© */
            --primary: #2c3e50;       /* Ø£Ø²Ø±Ù‚ ØºØ§Ù…Ù‚ */
            --primary-light: #ecf0f1; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ */
            --accent: #27ae60;        /* Ø£Ø®Ø¶Ø± Ù‡Ø§Ø¯Ø¦ */
            --bg-color: #f4f7f6;      
            --white: #ffffff;
            --text-dark: #2c3e50;     
            --border: #dfe6e9;        
            --error: #e74c3c;         
            --warning: #f39c12;       
            --info: #3498db;          
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            overflow: hidden;
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        #landingPage {
            padding: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            background: linear-gradient(to bottom, #fff, #f9fbfd);
        }

        .landing-header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .start-section {
            background: var(--primary-light);
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .designer-info {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #95a5a6;
            font-size: 0.9rem;
            width: 100%;
        }
        .designer-name { color: var(--accent); font-weight: bold; }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ --- */
        .workspace-toolbar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .toolbar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .toolbar-section-left { display: flex; gap: 10px; flex-wrap: wrap; }
        .toolbar-section-right { display: flex; gap: 10px; flex-wrap: wrap; margin-right: auto; }

        select {
            padding: 8px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            background: white;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn:hover { opacity: 0.9; }

        .btn-primary { background-color: var(--primary); }
        .btn-accent { background-color: var(--accent); }
        .btn-danger { background-color: var(--error); }
        .btn-warning { background-color: var(--warning); color: #2d3436; }
        .btn-info { background-color: var(--info); }
        .btn-purple { background-color: #9b59b6; }
        .btn-dark { background-color: #34495e; }
        .btn-vertical-mode { background-color: #95a5a6; color: white; }
        .btn-vertical-mode.active { background-color: #27ae60; box-shadow: 0 0 5px #27ae60; }
        
        .workspace { display: none; flex-direction: column; }
        .workspace.active { display: flex; }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .section-tabs-container { display: flex; gap: 5px; padding: 10px 20px 0; background: #fff; border-bottom: 2px solid #eee; overflow-x: auto; }
        .tab-btn { padding: 8px 20px; background: #f8f9fa; border: 1px solid #ddd; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: bold; color: #7f8c8d; white-space: nowrap; position: relative; top: 2px; }
        .tab-btn.active { background: #fff; color: var(--primary); border-color: #eee; border-bottom: 2px solid #fff; z-index: 2; box-shadow: 0 -2px 5px rgba(0,0,0,0.02); }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ */
        .table-wrapper { overflow-x: auto; padding-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        thead { background-color: #ecf0f1; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th { padding: 12px 8px; color: #2c3e50; font-weight: 700; border-bottom: 2px solid #bdc3c7; white-space: nowrap; font-size: 0.9rem; text-align: center; }
        td { padding: 0; border-bottom: 1px solid #eee; text-align: center; height: 40px; }
        tr:hover { background-color: #f9f9f9; }
        
        .grade-input {
            width: 100%; height: 100%; border: none; text-align: center; font-family: 'Cairo', sans-serif; font-size: 1rem; background: transparent; outline: none; color: #2c3e50;
            transition: background 0.2s;
        }
        .grade-input:focus { background-color: #e3f2fd; box-shadow: inset 0 0 0 2px var(--info); }
        .grade-input:hover { background-color: #fafafa; }
        
        td.name-cell { 
            text-align: right; 
            padding-right: 8px; 
            font-weight: 600; 
            font-size: 0.85rem; 
            color: #34495e; 
            min-width: 180px; 
            max-width: 220px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        td.total-cell { font-weight: 800; color: var(--primary); background-color: #fdfdfd; font-size: 1.1rem; }
        td.section-cell { font-size: 0.85rem; color: #7f8c8d; }

        /* ØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        .print-title-row { display: none; }
        
        /* Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØµØµ Ù„ØµÙØ­Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        .analysis-print-title { display: none; text-align: center; border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 10px; font-size: 1.4rem; font-weight: bold; }

        /* Ø§Ù„ØªØ­Ù„ÙŠÙ„ */
        .analysis-section { padding: 30px; border-top: 1px solid #eee; display: none; background: #fff; }
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; text-align: center; border-bottom-width: 3px; }
        .stat-num { font-size: 1.8rem; font-weight: bold; margin-top: 5px; }
        .rates-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .rate-card { padding: 15px; border-radius: 8px; text-align: center; border: 1px solid; }
        .rate-card.red { background-color: #fff5f5; border-color: #ff7675; color: #e17055; }
        .rate-card.green { background-color: #f0fdf4; border-color: #00b894; color: #00b894; }
        .rate-box h5 { margin: 0 0 10px; font-size: 1.1rem; }
        .rate-val { font-size: 2rem; font-weight: bold; font-family: monospace; }

        .lists-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #dfe6e9; }
        .list-card { border: 1px solid #eee; border-radius: 8px; padding: 15px; }
        .list-card h4 { margin-top: 0; border-bottom: 2px solid; padding-bottom: 10px; font-size: 1.1rem; margin-bottom: 10px; }
        .top-list h4 { border-color: #2ecc71; color: #27ae60; }
        .bottom-list h4 { border-color: #ff7675; color: #e74c3c; }
        .student-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f5f5f5; }
        .student-item:last-child { border-bottom: none; }
        .student-score { font-weight: bold; font-family: monospace; font-size: 1.1em; }
        .top-list .student-score { color: #27ae60; }
        .bottom-list .student-score { color: #e74c3c; }

        /* Modals & Notifications */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1500; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 95%; max-height: 85vh; overflow-y: auto; } 
        textarea { width: 100%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; resize: vertical; }
        #notification-area { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .notif { padding: 10px 20px; border-radius: 5px; color: white; margin-bottom: 5px; opacity: 0; transition: 0.3s; transform: translateY(-20px); }
        .notif.show { opacity: 1; transform: translateY(0); }
        .notif.success { background: var(--accent); } .notif.error { background: var(--error); } .notif.info { background: var(--info); }

        /* Print */
        @media print {
            @page { size: landscape; margin: 1cm; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; zoom: 90%; }
            .container { box-shadow: none; border: none; margin: 0; width: 100%; max-width: 100%; }
            .workspace-toolbar, .section-tabs-container, .btn, .action-btn, #landingPage, .modal, .input-row-add { display: none !important; }
            .workspace { display: block !important; }
            
            /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ø§Ù… ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
            .print-header { display: none !important; }
            
            table { border: 1px solid #000; width: 100%; font-size: 10pt; page-break-after: always; } 
            th, td { border: 1px solid #000; padding: 4px; color: black; text-align: center; height: auto; page-break-inside: avoid; }
            
            /* ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙÙŠ ÙƒÙ„ ØµÙØ­Ø© Ø¬Ø¯ÙˆÙ„ */
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            
            /* Ø¥Ø¸Ù‡Ø§Ø± ØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .print-title-row { display: table-row !important; }
            .print-title-row th { background-color: #fff !important; border: none !important; border-bottom: 2px solid #000 !important; font-size: 1.4rem; padding: 15px; }

            td.name-cell { font-size: 9pt; font-weight: normal; min-width: auto; width: 20%; text-align: right; padding-right: 5px; }
            .grade-input { text-align: center; padding: 0; font-size: 10pt; }
            
            /* ØªÙ†Ø³ÙŠÙ‚ ØµÙØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ */
            .analysis-section { 
                display: block !important; 
                page-break-before: always; 
                border: none; 
                margin-top: 0; 
                padding: 20px; 
            }
            
            .analysis-print-title { display: block; } /* Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†ÙˆØ§Ù† ØµÙØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ */
            
            .lists-wrapper {
                page-break-before: always; 
                margin-top: 20px;
                border-top: none;
            }
            
            .analysis-section h3 { display: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ù‚Ø³Ù… Ù„Ø£Ù†Ù‡ Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ù…Ø®ØµØµØ© */

            .print-footer { display: flex !important; justify-content: space-between; margin-top: 30px; padding-top: 10px; border-top: 1px solid #ccc; page-break-inside: avoid; }
            .designer-credit { display: none !important; }
            input[type="number"] { border: none; background: none; width: auto; appearance: textfield; -moz-appearance: textfield; }
            input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        }
        .print-header, .print-footer { display: none; }
    </style>
</head>
<body>

<div id="notification-area"></div>
<input type="file" id="restoreFileInput" style="display:none;" accept=".json" onchange="restoreBackup(this)">

<!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="landingPage">
    <div class="landing-header">
        <h1 style="color:var(--primary)">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h1>
        <p>Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</p>
    </div>

    <div class="start-section">
        <label style="display:block; margin-bottom:15px; font-weight:bold; color:var(--primary); font-size:1.2rem;">ğŸ‘‡ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
        <select id="landingGradeSelect" onchange="startApp(this.value)" style="width:100%; padding:15px; font-size:1.1rem; border:2px solid var(--accent); border-radius:8px;">
            <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
            <optgroup label="Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©">
                <option value="5-9">Ø§Ù„ØµÙÙˆÙ (5 - 9)</option>
            </optgroup>
            <optgroup label="Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ">
                <option value="10-11">Ø§Ù„ØµÙÙˆÙ (10 - 11)</option>
                <option value="12">Ø§Ù„ØµÙ (12)</option>
            </optgroup>
        </select>
    </div>
    
    <div class="designer-info">
        ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: <span style="color:var(--accent); font-weight:bold;">Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø®Ù„Ù Ø§Ù„Ø±ÙˆØ§Ø­ÙŠ</span>
    </div>
</div>

<!-- Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ -->
<div id="workspace" class="workspace">
    
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
    <div class="workspace-toolbar">
        <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ -->
        <div class="toolbar-row">
            <div class="toolbar-section-left">
                <button class="btn btn-danger" onclick="returnToMain()">ğŸ  Ø®Ø±ÙˆØ¬ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <span style="font-weight:bold; color:var(--primary); font-size:1.1rem; padding:0 10px; border-right:2px solid #ddd;" id="currentStageLabel"></span>
            </div>
            <div class="toolbar-section-right" style="display: flex; align-items: center; gap: 5px;">
                 <label style="font-size:0.9rem; color:#555;">ğŸ“¥ Ø¥Ø¯Ø±Ø§Ø¬ Ø´Ø¹Ø¨Ø©:</label>
                 <select id="bulkImportSelect" onchange="importSectionStudents(this.value)" style="min-width:150px; border-color: var(--accent);">
                    <option value="">-- Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø© --</option>
                </select>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ -->
        <div class="toolbar-row">
            <div class="toolbar-section-left">
                <button class="btn btn-purple" onclick="downloadBackup()">ğŸ“¥ Ø­ÙØ¸ Ù†Ø³Ø®Ø©</button>
                <button class="btn btn-primary" onclick="document.getElementById('restoreFileInput').click()">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
                <button class="btn btn-warning" onclick="openClearModal()">ğŸ—‘ï¸ ØªØµÙÙŠØ©</button>
                <!-- Ø²Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ -->
                <button id="verticalModeBtn" class="btn btn-vertical-mode" onclick="toggleVerticalMode()">â¬‡ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù…ÙˆØ¯ÙŠ: Ù…Ø¹Ø·Ù„</button>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù„Ø« -->
        <div class="toolbar-row">
            <div class="toolbar-section-left">
                 <button class="btn btn-info" onclick="openNamesModal()">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø´Ø¹Ø¨</button>
            </div>
            <div class="toolbar-section-right">
                <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                <button class="btn btn-accent" onclick="exportToExcel()">ğŸ“Š Excel</button>
            </div>
        </div>
    </div>

    <div class="print-header">
        <h1>Ø³Ø¬Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</h1>
        <p id="printPageSubHeader"></p>
    </div>

    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div id="sectionTabs" class="section-tabs-container"></div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ -->
    <div class="table-wrapper">
        <table id="gradesTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
        
        <!-- ØµÙ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ ÙØ±Ø¯ÙŠ Ø³Ø±ÙŠØ¹ -->
        <div class="input-row-add" style="padding:10px; background:#fff; border-bottom:1px solid #eee; display:flex; gap:10px; align-items:center; justify-content:center;">
            <input type="text" id="quickAddName" placeholder="Ø§Ø³Ù… Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯..." style="padding:8px; border:1px solid #ddd; border-radius:5px; width:250px;">
            <button class="btn btn-accent" onclick="quickAddStudent()">+ Ø¥Ø¶Ø§ÙØ©</button>
        </div>

        <div id="emptyMsg" style="text-align: center; padding: 30px; color: #bdc3c7; display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>
    </div>

    <!-- Ø§Ù„ØªØ­Ù„ÙŠÙ„ -->
    <div id="analysisSection" class="analysis-section">
        
        <!-- ØªØ±ÙˆÙŠØ³Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© ØµÙØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ -->
        <div class="analysis-print-title">
            Ø³Ø¬Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© - <span id="analysisPrintStageName"></span>
        </div>

        <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±: Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ÙˆØ§Ù„Ø±Ù‚Ù…ÙŠ -->
        <div class="report-page-1">
            <h3 style="color:var(--primary); margin-bottom:20px;">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
            <div class="stats-grid">
                <div class="stat-card" style="border-bottom-color:#e74c3c"><h5>Ø¶Ø¹ÙŠÙ</h5><div id="statWeak" class="stat-num" style="color:#e74c3c">0</div></div>
                <div class="stat-card" style="border-bottom-color:#f39c12"><h5>Ù…Ù‚Ø¨ÙˆÙ„</h5><div id="statAcc" class="stat-num" style="color:#f39c12">0</div></div>
                <div class="stat-card" style="border-bottom-color:#3498db"><h5>Ø¬ÙŠØ¯</h5><div id="statGood" class="stat-num" style="color:#3498db">0</div></div>
                <div class="stat-card" style="border-bottom-color:#1abc9c"><h5>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</h5><div id="statVGood" class="stat-num" style="color:#1abc9c">0</div></div>
                <div class="stat-card" style="border-bottom-color:#2ecc71"><h5>Ù…Ù…ØªØ§Ø²</h5><div id="statExc" class="stat-num" style="color:#2ecc71">0</div></div>
            </div>
            <div class="rates-grid">
                <div class="rate-card red"><h5>âš ï¸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯Ù†ÙŠ (< 5)</h5><div class="stat-num" id="rateLow">0%</div></div>
                <div class="rate-card green"><h5>ğŸŒŸ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙÙˆÙ‚ (Ø£ØŒ Ø¨)</h5><div class="stat-num" id="rateHigh">0%</div></div>
            </div>
            <div class="chart-wrapper"><canvas id="analysisChart"></canvas></div>
        </div>

        <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±: Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ø³ÙŠØªÙ… ÙØµÙ„Ù‡ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
        <div class="lists-wrapper">
            <!-- ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… -->
            <div class="analysis-print-title" style="display:none; margin-bottom:20px;">
                Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø·Ù„Ø¨Ø© - <span id="listPrintStageName"></span>
            </div>
            <div class="list-card top-list"><h4 style="color:#27ae60; border-color:#2ecc71">ğŸŒŸ Ø§Ù„Ø®Ù…Ø³Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h4><div id="topList"></div></div>
            <div class="list-card bottom-list"><h4 style="color:#c0392b; border-color:#e74c3c">âš ï¸ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h4><div id="bottomList"></div></div>
        </div>
    </div>

    <div class="print-footer">
        <div style="flex:1; text-align:right;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…: ........................</div>
        <div style="flex:1; text-align:left;">ÙŠØ¹ØªÙ…Ø¯ØŒ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ........................</div>
    </div>
</div>

<!-- Modals -->
<div id="namesModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø¨ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡</h3>
        <div style="margin-bottom:10px;"><label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</label> <select id="modalStageSelect" onchange="loadSectionsForModal()" style="width:100%"><option value="5-9">5-9</option><option value="10-11">10-11</option><option value="12">12</option></select></div>
        <div style="margin-bottom:15px;"><label>Ø§Ù„Ø´Ø¹Ø¨Ø©:</label> <div id="modalSectionList" class="modal-section-list"></div> <input type="text" id="modalSectionName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©..." style="width:100%; padding:8px; border:1px solid #ddd; margin-top:5px;"></div>
        <label>Ø§Ù„Ø·Ù„Ø§Ø¨:</label><textarea id="modalNamesText"></textarea>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:15px;"><button class="btn btn-accent" onclick="saveSectionNames()">ğŸ’¾ Ø­ÙØ¸</button><button class="btn btn-danger" onclick="document.getElementById('namesModal').classList.remove('active')">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
</div>

<div id="clearModal" class="modal">
    <div class="modal-content" style="max-width:400px; text-align:center;">
        <h3 style="color:var(--error);">âš ï¸ ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <div style="display:flex; flex-direction:column; gap:10px; margin:20px 0;">
            <button class="btn btn-warning" onclick="executeClear(1)">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙÙ‚Ø·</button>
            <button class="btn btn-warning" onclick="executeClear(2)">ğŸ“‹ Ù…Ø³Ø­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø´Ø¹Ø¨</button>
            <button class="btn btn-danger" onclick="executeClear(3)">ğŸ”¥ Ù…Ø³Ø­ Ø´Ø§Ù…Ù„</button>
        </div>
        <button class="btn btn-dark" onclick="document.getElementById('clearModal').classList.remove('active')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script>
    const SCHEMAS = {
        '5-9': { name: 'Ø§Ù„ØµÙÙˆÙ (5-9)', total: 60, fields: [{ id: 'oral', label: 'Ø§Ù„Ø¹Ø±Ø¶<br>Ø§Ù„Ø´ÙÙˆÙŠ<br>(10)', max: 10 }, { id: 'q1', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(5)', max: 5 }, { id: 'q2', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(5)', max: 5 }, { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(15)', max: 15, isKey: true }, { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(15)', max: 15 }, { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(10)', max: 10 }] },
        '10-11': { name: 'Ø§Ù„ØµÙÙˆÙ (10-11)', total: 40, fields: [{ id: 'q1', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(5)', max: 5 }, { id: 'q2', label: 'Ø§Ù„Ø³Ø¤Ø§Ù„<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(5)', max: 5 }, { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(10)', max: 10, isKey: true }, { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(10)', max: 10 }, { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(10)', max: 10 }] },
        '12': { name: 'Ø§Ù„ØµÙ (12)', total: 30, fields: [{ id: 'shortQ', label: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©<br>Ø§Ù„Ù‚ØµÙŠØ±Ø©<br>(5)', max: 5 }, { id: 'ex1', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 1<br>(10)', max: 10, isKey: true }, { id: 'ex2', label: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±<br>Ø§Ù„Ù‚ØµÙŠØ± 2<br>(10)', max: 10 }, { id: 'rep', label: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±<br>(5)', max: 5 }] }
    };

    let currentKey = null;
    let chartObj = null;
    let currentSectionFilter = "";
    let isVerticalMode = false;
    let dbSections = {}; 
    let dbGrades = { '5-9': [], '10-11': [], '12': [] };

    window.onload = () => { loadData(); initChart(); };

    function loadData() {
        const sec = localStorage.getItem('ss_sections');
        const grd = localStorage.getItem('ss_grades');
        if(sec) try { dbSections = JSON.parse(sec); } catch(e) { dbSections = {}; }
        if(grd) try { dbGrades = JSON.parse(grd); } catch(e) { dbGrades = { '5-9': [], '10-11': [], '12': [] }; }
    }

    function saveData() {
        localStorage.setItem('ss_sections', JSON.stringify(dbSections));
        localStorage.setItem('ss_grades', JSON.stringify(dbGrades));
    }

    function startApp(key) {
        currentKey = key;
        currentSectionFilter = "";
        document.getElementById('landingPage').style.display = 'none';
        document.getElementById('workspace').classList.add('active');
        document.getElementById('currentStageLabel').innerText = SCHEMAS[key].name;
        // ØªØ­Ø¯ÙŠØ« ØªØ±ÙˆÙŠØ³Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
        document.getElementById('analysisPrintStageName').innerText = SCHEMAS[key].name;
        document.getElementById('listPrintStageName').innerText = SCHEMAS[key].name;
        
        updateSectionDropdown();
        renderSectionTabs();
        renderTable();
    }

    function returnToMain() {
        currentKey = null;
        document.getElementById('landingGradeSelect').value = "";
        document.getElementById('workspace').classList.remove('active');
        document.getElementById('landingPage').style.display = 'flex';
    }

    function toggleVerticalMode() {
        isVerticalMode = !isVerticalMode;
        const btn = document.getElementById('verticalModeBtn');
        if (isVerticalMode) {
            btn.innerText = "â¬‡ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù…ÙˆØ¯ÙŠ: Ù…ÙØ¹Ù„";
            btn.classList.add('active');
        } else {
            btn.innerText = "â¬‡ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù…ÙˆØ¯ÙŠ: Ù…Ø¹Ø·Ù„";
            btn.classList.remove('active');
        }
    }

    function handleGradeNavigation(e, rowIdx, colId) {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (isVerticalMode) {
                let nextInput = document.getElementById(`grade-${rowIdx + 1}-${colId}`);
                if (nextInput) { nextInput.focus(); nextInput.select(); }
            } else {
                let inputs = Array.from(document.querySelectorAll('.grade-input'));
                let idx = inputs.indexOf(e.target);
                if (idx > -1 && idx < inputs.length - 1) { inputs[idx + 1].focus(); inputs[idx + 1].select(); }
            }
        } else if (e.key === 'ArrowDown') {
             e.preventDefault();
             let nextInput = document.getElementById(`grade-${rowIdx + 1}-${colId}`);
             if (nextInput) { nextInput.focus(); nextInput.select(); }
        } else if (e.key === 'ArrowUp') {
             e.preventDefault();
             let prevInput = document.getElementById(`grade-${rowIdx - 1}-${colId}`);
             if (prevInput) { prevInput.focus(); prevInput.select(); }
        }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const schema = SCHEMAS[currentKey];
        
        // ØªØ¶Ù…ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© ÙÙŠ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø®ØªØ§Ø±Ø©
        let printTitle = `Ø³Ø¬Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© - ${schema.name}`;
        if (currentSectionFilter) {
            printTitle += ` - Ø´Ø¹Ø¨Ø©: ${currentSectionFilter}`;
            // ØªØ­Ø¯ÙŠØ« ØªØ±ÙˆÙŠØ³Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø£ÙŠØ¶Ø§
            document.getElementById('analysisPrintStageName').innerText = `${schema.name} - Ø´Ø¹Ø¨Ø©: ${currentSectionFilter}`;
            document.getElementById('listPrintStageName').innerText = `${schema.name} - Ø´Ø¹Ø¨Ø©: ${currentSectionFilter}`;
        } else {
            document.getElementById('analysisPrintStageName').innerText = schema.name;
            document.getElementById('listPrintStageName').innerText = schema.name;
        }

        const headerRow = document.getElementById('tableHead');
        // Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        let hHtml = `
            <tr class="print-title-row">
                <th colspan="100%">${printTitle}</th>
            </tr>
            <tr>
                <th style="width:50px">#</th>
                <th style="text-align:right; min-width:250px">Ø§Ù„Ø§Ø³Ù…</th>
                <th style="width:80px">Ø§Ù„Ø´Ø¹Ø¨Ø©</th>`;
        
        schema.fields.forEach(f => hHtml += `<th style="width:80px">${f.label}</th>`);
        hHtml += `<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹<br>(${schema.total})</th><th style="width:60px">Ø­Ø°Ù</th></tr>`;
        headerRow.innerHTML = hHtml;

        let data = dbGrades[currentKey] || [];
        let visibleData = [];
        let counter = 1;
        
        data.forEach((item, originalIndex) => {
            if(currentSectionFilter && item.section !== currentSectionFilter) return;
            visibleData.push(item);

            const tr = document.createElement('tr');
            
            let html = `<td>${counter++}</td>
                        <td class="name-cell">${item.name}</td>
                        <td class="section-cell">${item.section}</td>`;
            
            schema.fields.forEach(f => {
                let val = item.scores[f.id] || "";
                html += `<td><input type="number" class="grade-input" 
                         id="grade-${originalIndex}-${f.id}"
                         value="${val}" 
                         min="0" max="${f.max}" step="0.5" 
                         onkeydown="handleGradeNavigation(event, ${originalIndex}, '${f.id}')"
                         onchange="updateGrade(${originalIndex}, '${f.id}', this.value)"></td>`;
            });

            html += `<td class="total-cell" id="total-${originalIndex}">${item.total}</td>
                     <td><button class="action-btn del-btn" onclick="deleteItem(${originalIndex})">âœ•</button></td>`;
            
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        document.getElementById('emptyMsg').style.display = visibleData.length ? 'none' : 'block';
        updateAnalysis(visibleData);
    }

    function updateGrade(index, fieldId, value) {
        const student = dbGrades[currentKey][index];
        const schema = SCHEMAS[currentKey];
        const field = schema.fields.find(f => f.id === fieldId);
        
        let numVal = parseFloat(value);
        if (isNaN(numVal)) numVal = 0;

        if (numVal > field.max) {
            alert(`Ø®Ø·Ø£: Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ Ù‡ÙŠ ${field.max}`);
            numVal = field.max;
            document.getElementById(`grade-${index}-${fieldId}`).value = numVal;
        } else if (numVal < 0) {
            numVal = 0;
            document.getElementById(`grade-${index}-${fieldId}`).value = numVal;
        }

        student.scores[fieldId] = numVal;
        if(field.isKey) student.keyScore = numVal;

        let newTotal = 0;
        schema.fields.forEach(f => {
            newTotal += (parseFloat(student.scores[f.id]) || 0);
        });
        student.total = newTotal;

        document.getElementById(`total-${index}`).innerText = newTotal;
        saveData();
        const visibleData = dbGrades[currentKey].filter(item => !currentSectionFilter || item.section === currentSectionFilter);
        updateAnalysis(visibleData);
    }

    function quickAddStudent() {
        const nameInput = document.getElementById('quickAddName');
        const name = nameInput.value.trim();
        if(!name) return;

        const schema = SCHEMAS[currentKey];
        let emptyScores = {};
        schema.fields.forEach(f => emptyScores[f.id] = 0);
        
        const section = currentSectionFilter || "Ø¹Ø§Ù…";

        if(!dbGrades[currentKey]) dbGrades[currentKey] = [];
        dbGrades[currentKey].push({
            name: name, section: section, scores: emptyScores, total: 0, keyScore: 0
        });

        saveData();
        renderTable();
        nameInput.value = "";
        nameInput.focus();
    }

    function importSectionStudents(sectionName) {
        if (!sectionName || !dbSections[currentKey] || !dbSections[currentKey][sectionName]) return;
        const names = dbSections[currentKey][sectionName].split('\n').map(n=>n.trim()).filter(n=>n);
        if(!names.length) return alert("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©");

        let count = 0;
        const schema = SCHEMAS[currentKey];
        let emptyScores = {};
        schema.fields.forEach(f => emptyScores[f.id] = 0);
        if(!dbGrades[currentKey]) dbGrades[currentKey] = [];

        names.forEach(name => {
            if(!dbGrades[currentKey].some(s => s.name === name)) {
                dbGrades[currentKey].push({ name, section: sectionName, scores: {...emptyScores}, total: 0, keyScore: 0 });
                count++;
            }
        });

        if(count > 0) {
            saveData();
            switchTab(sectionName); 
            alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${count} Ø·Ø§Ù„Ø¨.`);
        } else {
            alert("Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ÙˆÙ† Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
        }
        document.getElementById('bulkImportSelect').value = "";
    }

    function renderSectionTabs() {
        const container = document.getElementById('sectionTabs');
        container.innerHTML = '';
        const allBtn = document.createElement('button');
        allBtn.className = `tab-btn ${currentSectionFilter===""?"active":""}`;
        allBtn.innerText = "Ø§Ù„ÙƒÙ„";
        allBtn.onclick = () => switchTab("");
        container.appendChild(allBtn);

        if(dbSections[currentKey]) {
            Object.keys(dbSections[currentKey]).forEach(sec => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${currentSectionFilter===sec?"active":""}`;
                btn.innerText = sec;
                btn.onclick = () => switchTab(sec);
                container.appendChild(btn);
            });
        }
    }
    function switchTab(sec) { currentSectionFilter = sec; renderSectionTabs(); renderTable(); }
    
    function updateSectionDropdown() {
        const sel = document.getElementById('bulkImportSelect');
        sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø´Ø¹Ø¨Ø© Ù„Ù„Ø¥Ø¯Ø±Ø§Ø¬ --</option>';
        if(dbSections[currentKey]) {
            Object.keys(dbSections[currentKey]).forEach(sec => {
                sel.innerHTML += `<option value="${sec}">${sec}</option>`;
            });
        }
    }

    function deleteItem(idx) {
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) {
            dbGrades[currentKey].splice(idx, 1);
            saveData();
            renderTable();
        }
    }

    function updateAnalysis(data) {
        const section = document.getElementById('analysisSection');
        if(data.length === 0) { section.style.display = 'none'; return; }
        section.style.display = 'block';

        const max = SCHEMAS[currentKey].fields.find(f => f.isKey).max;
        let counts = [0,0,0,0,0]; 
        let low = 0, high = 0;

        data.forEach(d => {
            let s = d.keyScore || 0;
            if(max === 15) {
                if(s < 7.5) counts[0]++; else if(s < 9.75) counts[1]++; else if(s < 12) counts[2]++; else if(s < 13.5) counts[3]++; else counts[4]++;
            } else {
                if(s < 5) counts[0]++; else if(s < 6.5) counts[1]++; else if(s < 8) counts[2]++; else if(s < 9) counts[3]++; else counts[4]++;
            }
            if(s < 5) low++;
            if((max===15 && s>=12) || (max===10 && s>=8)) high++;
        });

        ['Weak','Acc','Good','VGood','Exc'].forEach((k, i) => document.getElementById('stat'+k).innerText = counts[i]);
        document.getElementById('rateLow').innerText = Math.round((low/data.length)*100) + "%";
        document.getElementById('rateHigh').innerText = Math.round((high/data.length)*100) + "%";

        chartObj.data.datasets[0].data = counts;
        chartObj.update();
        
        const sorted = [...data].sort((a,b) => b.total - a.total);
        document.getElementById('topList').innerHTML = sorted.slice(0,5).map(i => `<div class="student-item"><span>${i.name}</span><b class="student-score">${i.total}</b></div>`).join('');
        document.getElementById('bottomList').innerHTML = [...sorted].reverse().slice(0,5).map(i => `<div class="student-item"><span>${i.name}</span><b class="student-score">${i.total}</b></div>`).join('');
    }

    function initChart() {
        const ctx = document.getElementById('analysisChart').getContext('2d');
        chartObj = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['Ø¶Ø¹ÙŠÙ','Ù…Ù‚Ø¨ÙˆÙ„','Ø¬ÙŠØ¯','Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹','Ù…Ù…ØªØ§Ø²'], datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨', data: [0,0,0,0,0], backgroundColor: ['#e74c3c','#f39c12','#3498db','#1abc9c','#2ecc71'] }] },
            options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{stepSize:1} } } }
        });
    }

    function openNamesModal() {
        document.getElementById('namesModal').classList.add('active');
        document.getElementById('modalStageSelect').value = currentKey || "5-9";
        loadSectionsForModal();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function loadSectionsForModal() {
        const stage = document.getElementById('modalStageSelect').value;
        const div = document.getElementById('modalSectionList');
        div.innerHTML = '';
        if(dbSections[stage]) {
            Object.keys(dbSections[stage]).forEach(sec => {
                const btn = document.createElement('div');
                btn.className = 'section-tag'; btn.innerText = sec;
                btn.onclick = () => {
                    document.getElementById('modalSectionName').value = sec;
                    document.getElementById('modalNamesText').value = dbSections[stage][sec];
                    document.querySelectorAll('.section-tag').forEach(t=>t.classList.remove('active'));
                    btn.classList.add('active');
                };
                div.appendChild(btn);
            });
        }
        const newBtn = document.createElement('div'); newBtn.className = 'section-tag new'; newBtn.innerText = '+ Ø¬Ø¯ÙŠØ¯Ø©';
        newBtn.onclick = () => { document.getElementById('modalSectionName').value=""; document.getElementById('modalNamesText').value=""; };
        div.appendChild(newBtn);
    }
    function saveSectionNames() {
        const stage = document.getElementById('modalStageSelect').value;
        const sec = document.getElementById('modalSectionName').value.trim();
        const txt = document.getElementById('modalNamesText').value;
        if(!sec) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©");
        if(!dbSections[stage]) dbSections[stage] = {};
        dbSections[stage][sec] = txt;
        saveData();
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
        loadSectionsForModal();
        if(stage === currentKey) { updateSectionDropdown(); renderSectionTabs(); }
    }

    function openClearModal() { document.getElementById('clearModal').classList.add('active'); }
    function executeClear(type) {
        document.getElementById('clearModal').classList.remove('active');
        setTimeout(() => {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
            if(type===1 || type===3) dbGrades[currentKey] = [];
            if(type===2 || type===3) delete dbSections[currentKey];
            saveData();
            if(currentKey) { updateSectionDropdown(); renderSectionTabs(); renderTable(); }
        }, 100);
    }

    function downloadBackup() {
        const data = { s: dbSections, g: dbGrades, date: new Date() };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'GradesBackup.json'; a.click();
    }
    function restoreBackup(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            try { const d = JSON.parse(e.target.result); dbSections=d.s; dbGrades=d.g; saveData(); location.reload(); }
            catch(err) { alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­"); }
        };
        r.readAsText(f);
    }

    function exportToExcel() {
        const tbl = document.getElementById('gradesTable');
        let html = tbl.outerHTML.replace(/<input[^>]*value="([^"]*)"[^>]*>/g, "$1"); 
        html = html.replace(/<button.*?>.*?<\/button>/g, "");
        const blob = new Blob(['\ufeff'+html], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'Grades.xls'; a.click();
    }
    function printAnalysisOnly() {
        document.body.classList.add('print-analysis-only');
        window.print();
        document.body.classList.remove('print-analysis-only');
    }
</script>
</body>
</html>